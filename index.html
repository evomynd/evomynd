<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVOMYND</title>
    <!-- PWA meta tags for home screen app name -->
    <meta name="application-name" content="EVOMYND">
    <meta name="apple-mobile-web-app-title" content="EVOMYND">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ffffff">
    
    <!-- √çcones para diferentes dispositivos e resolu√ß√µes -->
    <link rel="icon" type="image/png" href="https://github.com/evomynd/evomynd/blob/main/Logo.png?raw=true">
    <link rel="apple-touch-icon" href="https://github.com/evomynd/evomynd/blob/main/Logo.png?raw=true">
    <link rel="apple-touch-icon" sizes="152x152" href="https://github.com/evomynd/evomynd/blob/main/Logo.png?raw=true">
    <link rel="apple-touch-icon" sizes="167x167" href="https://github.com/evomynd/evomynd/blob/main/Logo.png?raw=true">
    <link rel="apple-touch-icon" sizes="180x180" href="https://github.com/evomynd/evomynd/blob/main/Logo.png?raw=true">
    
    <!-- Android -->
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" sizes="192x192" href="https://github.com/evomynd/evomynd/blob/main/Logo.png?raw=true">
    <link rel="icon" sizes="512x512" href="https://github.com/evomynd/evomynd/blob/main/Logo.png?raw=true">
    
    <!-- Splash screen para iOS -->
    <link rel="apple-touch-startup-image" href="https://github.com/evomynd/evomynd/blob/main/Logo.png?raw=true">
    
    <!-- Firebase SDKs -->
    <script type="module">
        // Imports do Firebase
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, writeBatch } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyA2j9f-qaqCqjxVaYON-oJ3Q06_XG0mjMw",
            authDomain: "evomynd.firebaseapp.com",
            projectId: "evomynd",
            storageBucket: "evomynd.firebasestorage.app",
            messagingSenderId: "267903971507",
            appId: "1:267903971507:web:e85f8a9795dfa5056740c6"
        };
        
        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Logs de diagn√≥stico
        console.log('üî• Firebase inicializado com sucesso!');
        console.log('üìç Projeto:', firebaseConfig.projectId);
        console.log('üåê Dom√≠nio atual:', window.location.hostname);
        console.log('‚ö†Ô∏è Se houver erro de login, adicione este dom√≠nio em:');
        console.log('   Firebase Console > Authentication > Settings > Authorized domains');
        
        // Disponibilizar globalmente
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseAuthMethods = { GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged };
        window.firebaseDbMethods = { doc, setDoc, getDoc, onSnapshot, collection, writeBatch };
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        /* Estilos customizados para transi√ß√µes e foco */
        .view {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .view.hidden {
            opacity: 0;
            transform: scale(0.95);
            display: none;
        }
        .task-item:hover .task-actions {
            opacity: 1;
        }
        .modal-overlay {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out;
        }
        .subtasks-container {
            transition: all 0.3s ease-in-out;
            max-height: 0;
            overflow: hidden;
            padding-top: 0;
            padding-bottom: 0;
        }
        .subtasks-container:not(.hidden) {
            max-height: 1000px; /* valor alto para permitir expans√£o */
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        .tutorial-highlight {
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.7);
            border-radius: 8px;
            transition: box-shadow 0.3s ease-in-out;
            position: relative;
            z-index: 100;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100 font-sans antialiased">

    <!-- Tela de Login Obrigat√≥rio -->
    <div id="login-required-screen" class="hidden fixed inset-0 bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-gray-800 z-[9999] flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8 md:p-12 max-w-md w-full text-center">
            <div class="mb-6">
                <svg class="w-20 h-20 mx-auto text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                </svg>
            </div>
            <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-4">Login Necess√°rio</h2>
            <p class="text-gray-600 dark:text-gray-300 mb-8">Para usar o EVOMYND, voc√™ precisa fazer login com sua conta Google.</p>
            <button id="login-required-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg transition shadow-lg hover:shadow-xl active:shadow-md transform hover:-translate-y-0.5 active:translate-y-0 flex items-center justify-center gap-3">
                <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12.545,10.239v3.821h5.445c-0.712,2.315-2.647,3.972-5.445,3.972c-3.332,0-6.033-2.701-6.033-6.032s2.701-6.032,6.033-6.032c1.498,0,2.866,0.549,3.921,1.453l2.814-2.814C17.503,2.988,15.139,2,12.545,2C7.021,2,2.543,6.477,2.543,12s4.478,10,10.002,10c8.396,0,10.249-7.85,9.426-11.748L12.545,10.239z"/>
                </svg>
                Fazer Login com Google
            </button>
        </div>
    </div>

    <!-- Tela de Assinatura Expirada -->
    <div id="subscription-expired-screen" class="hidden fixed inset-0 bg-gradient-to-br from-red-50 to-orange-100 dark:from-gray-900 dark:to-gray-800 z-[9999] flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8 md:p-12 max-w-md w-full text-center">
            <div class="mb-6">
                <svg class="w-20 h-20 mx-auto text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
            </div>
            <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-4">Assinatura Expirada</h2>
            <p class="text-gray-600 dark:text-gray-300 mb-2">Sua assinatura do EVOMYND expirou.</p>
            <p id="subscription-expire-date" class="text-sm text-gray-500 dark:text-gray-400 mb-8"></p>
            <div class="space-y-3">
                <button id="renew-subscription-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg transition shadow-lg hover:shadow-xl active:shadow-md transform hover:-translate-y-0.5 active:translate-y-0 flex items-center justify-center gap-3">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                    </svg>
                    Renovar Assinatura
                </button>
                <button id="logout-expired-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition">
                    Sair
                </button>
            </div>
        </div>
    </div>

    <!-- Tela de Carregamento -->
    <div id="loading-screen" class="fixed inset-0 bg-gray-50 dark:bg-gray-900 z-[9998] flex items-center justify-center">
        <div class="text-center">
            <div class="inline-block animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mb-4"></div>
            <p class="text-gray-600 dark:text-gray-400 text-lg">Verificando assinatura...</p>
        </div>
    </div>

    <div id="app" class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl">

        <header class="text-center mb-8">
            <div class="flex justify-between items-start mb-4">
                <!-- Bot√£o de Login/Usu√°rio -->
                <div id="auth-container" class="flex items-center gap-2">
                    <button id="login-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition shadow-lg hover:shadow-xl active:shadow-md transform hover:-translate-y-0.5 active:translate-y-0 text-sm flex items-center gap-2">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12.545,10.239v3.821h5.445c-0.712,2.315-2.647,3.972-5.445,3.972c-3.332,0-6.033-2.701-6.033-6.032s2.701-6.032,6.033-6.032c1.498,0,2.866,0.549,3.921,1.453l2.814-2.814C17.503,2.988,15.139,2,12.545,2C7.021,2,2.543,6.477,2.543,12s4.478,10,10.002,10c8.396,0,10.249-7.85,9.426-11.748L12.545,10.239z"/>
                        </svg>
                        Login
                    </button>
                    <div id="user-info" class="hidden flex items-center gap-3 bg-white dark:bg-gray-800 px-4 py-2 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
                        <img id="user-photo" src="" alt="User" class="w-8 h-8 rounded-full">
                        <div class="text-left">
                            <p id="user-name" class="text-sm font-semibold text-gray-900 dark:text-white"></p>
                            <p id="sync-status" class="text-xs text-green-600 dark:text-green-400">‚úì Sincronizado</p>
                        </div>
                    </div>
                </div>
                <button id="settings-btn" class="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-white font-bold py-2 px-4 rounded-md transition shadow-lg hover:shadow-xl active:shadow-md transform hover:-translate-y-0.5 active:translate-y-0">‚öôÔ∏è</button>
            </div>
            <h1 class="text-4xl sm:text-5xl font-bold text-gray-900 dark:text-white">EVOMYND</h1>
            <p class="text-lg text-gray-600 dark:text-gray-400 mt-2">Produtividade N√ÉO √© sin√¥nimo de estresse.</p>
        </header>

        <div class="mb-8 text-center flex gap-4 justify-center">
            <button data-view="calendar-view" class="nav-tab inline-flex items-center justify-center gap-2 p-4 rounded-lg text-center transition font-semibold text-lg w-full sm:w-auto sm:px-10 bg-white dark:bg-gray-800 text-gray-700 dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 border border-gray-300 dark:border-gray-700 shadow-lg hover:shadow-xl active:shadow-md transform hover:-translate-y-0.5 active:translate-y-0">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                Calend√°rio
            </button>
            <button id="weekly-review-btn" class="inline-flex flex-col items-center justify-center gap-1 p-4 rounded-lg text-center transition font-semibold text-lg w-full sm:w-auto sm:px-10 bg-green-600 text-white hover:bg-green-700 shadow-lg hover:shadow-xl active:shadow-md transform hover:-translate-y-0.5 active:translate-y-0">
                <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" />
                        <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm9.707 5.707a1 1 0 00-1.414-1.414L9 12.586l-1.293-1.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>
                    <span>Revis√£o Semanal</span>
                </div>
                <span id="next-review-date" class="text-xs font-normal opacity-75"></span>
            </button>
        </div>

        <!-- Navega√ß√£o Principal -->
        <nav class="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-8">
            <button data-view="inbox-view" class="nav-tab p-4 rounded-lg text-center transition font-medium bg-white dark:bg-gray-800 text-gray-700 dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 border border-gray-300 dark:border-gray-700 shadow-lg hover:shadow-xl active:shadow-md transform hover:-translate-y-0.5 active:translate-y-0">Caixa de Entrada</button>
            <button data-view="next-actions-view" class="nav-tab p-4 rounded-lg text-center transition font-medium bg-white dark:bg-gray-800 text-gray-700 dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 border border-gray-300 dark:border-gray-700 shadow-lg hover:shadow-xl active:shadow-md transform hover:-translate-y-0.5 active:translate-y-0">Pr√≥ximas A√ß√µes</button>
            <button data-view="projects-view" class="nav-tab p-4 rounded-lg text-center transition font-medium bg-white dark:bg-gray-800 text-gray-700 dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 border border-gray-300 dark:border-gray-700 shadow-lg hover:shadow-xl active:shadow-md transform hover:-translate-y-0.5 active:translate-y-0">Projetos</button>
            <button data-view="waiting-for-view" class="nav-tab p-4 rounded-lg text-center transition font-medium bg-white dark:bg-gray-800 text-gray-700 dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 border border-gray-300 dark:border-gray-700 shadow-lg hover:shadow-xl active:shadow-md transform hover:-translate-y-0.5 active:translate-y-0">Aguardando</button>
            <button data-view="someday-maybe-view" class="nav-tab p-4 rounded-lg text-center transition font-medium bg-white dark:bg-gray-800 text-gray-700 dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 border border-gray-300 dark:border-gray-700 shadow-lg hover:shadow-xl active:shadow-md transform hover:-translate-y-0.5 active:translate-y-0">Algum Dia/Talvez</button>
            <button data-view="reference-view" class="nav-tab p-4 rounded-lg text-center transition font-medium bg-white dark:bg-gray-800 text-gray-700 dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 border border-gray-300 dark:border-gray-700 shadow-lg hover:shadow-xl active:shadow-md transform hover:-translate-y-0.5 active:translate-y-0">Refer√™ncia</button>
        </nav>

        <main>
            <!-- Visualiza√ß√£o: Caixa de Entrada -->
            <div id="inbox-view" class="view">
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700">
                    <div class="flex flex-col sm:flex-row gap-2">
                        <input type="text" id="new-task-input" placeholder="O que est√° na sua mente?" class="flex-grow bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md py-3 px-4 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                        <button id="add-task-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-md transition duration-300 shadow-lg hover:shadow-xl active:shadow-md transform hover:-translate-y-0.5 active:translate-y-0 flex-shrink-0">Adicionar</button>
                    </div>
                </div>
                <div id="inbox-list" class="mt-8"></div>
            </div>

            <!-- Other views are the same -->
            <div id="next-actions-view" class="view hidden">
                 <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 mb-8">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-900 dark:text-white">Filtre por Contexto</h2>
                    <div id="context-filters" class="flex flex-wrap gap-3"></div>
                </div>
                <div id="next-actions-list"></div>
            </div>
            <div id="projects-view" class="view hidden">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700">
                    <h2 class="text-2xl font-semibold text-gray-900 dark:text-white">Projetos Ativos</h2>
                    <p class="text-gray-600 dark:text-gray-400 mt-1">Resultados que requerem mais de uma a√ß√£o.</p>
                </div>
                <div id="projects-list" class="mt-8"></div>
            </div>
            <div id="calendar-view" class="view hidden">
                 <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700">
                    <h2 class="text-2xl font-semibold text-gray-900 dark:text-white">Itens Agendados</h2>
                    <p class="text-gray-600 dark:text-gray-400 mt-1">Seus compromissos e tarefas com data marcada.</p>
                </div>
                <div id="calendar-list" class="mt-8"></div>
            </div>
            <div id="waiting-for-view" class="view hidden">
                 <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700">
                    <h2 class="text-2xl font-semibold text-gray-900 dark:text-white">Aguardando Resposta/Evento</h2>
                     <p class="text-gray-600 dark:text-gray-400 mt-1">Itens que delegou ou que dependem de outros.</p>
                </div>
                <div id="waiting-for-list" class="mt-8"></div>
            </div>
            <div id="someday-maybe-view" class="view hidden">
                 <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700">
                    <h2 class="text-2xl font-semibold text-gray-900 dark:text-white">Algum Dia / Talvez</h2>
                     <p class="text-gray-600 dark:text-gray-400 mt-1">Ideias para o futuro, sem compromisso imediato.</p>
                </div>
                <div id="someday-maybe-list" class="mt-8"></div>
            </div>
            <div id="reference-view" class="view hidden">
                 <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700">
                    <h2 class="text-2xl font-semibold text-gray-900 dark:text-white">Material de Refer√™ncia</h2>
                     <p class="text-gray-600 dark:text-gray-400 mt-1">Informa√ß√µes √∫teis e n√£o acion√°veis.</p>
                </div>
                <div id="reference-list" class="mt-8"></div>
            </div>
        </main>
    </div>

    <!-- Tutorial Modal -->
    <div id="tutorial-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-[100] hidden">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-lg relative">
            <div id="tutorial-content"></div>
            <div class="flex justify-between mt-6">
                <button id="tutorial-skip-btn" class="text-gray-500 hover:text-gray-900 transition">Pular</button>
                <button id="tutorial-next-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-md transition shadow-md hover:shadow-lg active:shadow-sm transform hover:-translate-y-0.5 active:translate-y-0">Pr√≥ximo</button>
            </div>
        </div>
    </div>


    <!-- Timer Overlay -->
    <div id="timer-overlay" class="fixed inset-0 bg-white dark:bg-gray-900 bg-opacity-95 dark:bg-opacity-95 flex flex-col items-center justify-center p-4 text-gray-900 dark:text-white hidden z-50">
        <h2 id="timer-task-text" class="text-3xl md:text-5xl font-bold mb-8 text-center"></h2>
        <div id="timer-display" class="text-8xl md:text-9xl font-mono font-bold">02:00</div>
        <div id="timer-running-controls" class="mt-12 flex flex-col sm:flex-row gap-4">
            <button id="timer-early-complete-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-md transition text-lg shadow-lg hover:shadow-xl active:shadow-md transform hover:-translate-y-0.5 active:translate-y-0">Concluir A√ß√£o</button>
            <button id="timer-pause-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-8 rounded-md transition text-lg shadow-lg hover:shadow-xl active:shadow-md transform hover:-translate-y-0.5 active:translate-y-0">Pausar</button>
            <button id="timer-cancel-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-8 rounded-md transition text-lg shadow-lg hover:shadow-xl active:shadow-md transform hover:-translate-y-0.5 active:translate-y-0">Cancelar</button>
        </div>
        <div id="timer-finished-controls" class="mt-12 flex flex-col sm:flex-row gap-4 hidden">
            <button id="timer-complete-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-md transition text-lg shadow-lg hover:shadow-xl active:shadow-md transform hover:-translate-y-0.5 active:translate-y-0">A√ß√£o Conclu√≠da</button>
            <button id="timer-restart-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-8 rounded-md transition text-lg shadow-lg hover:shadow-xl active:shadow-md transform hover:-translate-y-0.5 active:translate-y-0">Reiniciar Timer</button>
            <button id="timer-move-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-md transition text-lg shadow-lg hover:shadow-xl active:shadow-md transform hover:-translate-y-0.5 active:translate-y-0">Mover para Pr√≥ximas A√ß√µes</button>
        </div>
    </div>

    <!-- Modal para Processar / Editar Item -->
    <div id="task-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex items-start justify-center overflow-y-auto hidden">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-lg transform transition-all my-8 mx-4">
            <h3 id="modal-title" class="text-2xl font-bold text-gray-900 dark:text-white mb-6">Processar Item</h3>
            <p id="modal-task-text" class="bg-gray-100 dark:bg-gray-700 p-4 rounded-md text-gray-700 dark:text-gray-300 mb-6 hidden"></p>
            
            <form id="task-form">
                <input type="hidden" id="modal-task-id">
                <input type="hidden" id="modal-mode">
                <input type="hidden" id="original-due-date">
                <input type="hidden" id="original-due-time">
                <input type="hidden" id="original-end-time">
                
                <div id="destination-container" class="mb-4">
                    <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Mover para:</label>
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                        <label class="p-3 bg-gray-100 dark:bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600 transition text-gray-700 dark:text-white"><input type="radio" name="destination" value="next-action" class="sr-only">Pr√≥xima A√ß√£o</label>
                        <label class="p-3 bg-gray-100 dark:bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600 transition text-gray-700 dark:text-white"><input type="radio" name="destination" value="project" class="sr-only">Projeto</label>
                        <label class="p-3 bg-gray-100 dark:bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600 transition text-gray-700 dark:text-white"><input type="radio" name="destination" value="waiting" class="sr-only">Aguardando</label>
                        <label class="p-3 bg-gray-100 dark:bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600 transition text-gray-700 dark:text-white"><input type="radio" name="destination" value="someday" class="sr-only">Algum Dia</label>
                        <label class="p-3 bg-gray-100 dark:bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600 transition text-gray-700 dark:text-white"><input type="radio" name="destination" value="reference" class="sr-only">Refer√™ncia</label>
                    </div>
                </div>

                <div id="form-fields">
                    <!-- Fields will be dynamically inserted here -->
                </div>

                <div id="form-error" class="text-red-600 text-sm mt-4 mb-20"></div>
                
                <div id="modal-actions" class="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 border-t border-gray-300 dark:border-gray-700 p-4 z-[60]">
                    <div class="flex justify-end gap-4 container mx-auto max-w-lg">
                        <button type="button" id="cancel-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-md transition shadow-md hover:shadow-lg active:shadow-sm transform hover:-translate-y-0.5 active:translate-y-0">Cancelar</button>
                        <button type="submit" id="save-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-md transition shadow-md hover:shadow-lg active:shadow-sm transform hover:-translate-y-0.5 active:translate-y-0">Salvar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de A√ß√£o R√°pida -->
    <div id="quick-action-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-sm transform transition-all text-center">
            <p class="text-gray-900 dark:text-white text-lg mb-6">√â uma a√ß√£o de at√© 2 minutos e deseja fazer agora?</p>
            <div class="flex justify-center gap-4">
                <button id="quick-action-no-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-md transition shadow-md hover:shadow-lg active:shadow-sm transform hover:-translate-y-0.5 active:translate-y-0">N√£o</button>
                <button id="quick-action-yes-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-md transition shadow-md hover:shadow-lg active:shadow-sm transform hover:-translate-y-0.5 active:translate-y-0">Sim</button>
            </div>
        </div>
    </div>

    <!-- Modal de Agendamento -->
    <div id="schedule-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-lg transform transition-all">
            <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">Programar A√ß√£o</h3>
            <p id="schedule-task-text" class="bg-gray-100 dark:bg-gray-700 p-4 rounded-md text-gray-700 dark:text-gray-300 mb-6"></p>
            <div class="mb-4">
                <label for="schedule-date-input" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Data</label>
                <input type="date" id="schedule-date-input" min="${today}" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="schedule-time-input" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Hora de In√≠cio</label>
                    <input type="time" id="schedule-time-input" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="schedule-end-time-input" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Hora de T√©rmino</label>
                    <input type="time" id="schedule-end-time-input" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button id="schedule-later-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-md transition shadow-md hover:shadow-lg active:shadow-sm transform hover:-translate-y-0.5 active:translate-y-0">Agora n√£o</button>
                <button id="schedule-save-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-md transition disabled:bg-gray-500 disabled:cursor-not-allowed shadow-md hover:shadow-lg active:shadow-sm transform hover:-translate-y-0.5 active:translate-y-0" disabled>Programar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Confirma√ß√£o -->
    <div id="confirm-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-sm transform transition-all text-center">
            <p id="confirm-modal-text" class="text-gray-900 dark:text-white text-lg mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-cancel-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-md transition shadow-md hover:shadow-lg active:shadow-sm transform hover:-translate-y-0.5 active:translate-y-0">Cancelar</button>
                <button id="confirm-ok-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-md transition shadow-md hover:shadow-lg active:shadow-sm transform hover:-translate-y-0.5 active:translate-y-0">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Enviar ao Calend√°rio -->
    <div id="calendar-export-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-sm transform transition-all text-center">
            <p class="text-gray-900 dark:text-white text-lg mb-6">Deseja enviar este evento para o calend√°rio do seu dispositivo?</p>
            <div class="flex justify-center gap-4">
                <button id="calendar-export-no-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-md transition shadow-md hover:shadow-lg active:shadow-sm transform hover:-translate-y-0.5 active:translate-y-0">N√£o</button>
                <button id="calendar-export-yes-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-md transition shadow-md hover:shadow-lg active:shadow-sm transform hover:-translate-y-0.5 active:translate-y-0">Sim</button>
            </div>
        </div>
    </div>
    
    <!-- Revis√£o Semanal Footer -->
    <div id="weekly-review-footer" class="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 border-t border-gray-300 dark:border-gray-700 hidden z-50">
        <div class="container mx-auto max-w-4xl flex flex-col gap-3 p-4">
            <span id="weekly-review-step" class="text-green-600 dark:text-green-400 font-semibold text-center"></span>
            <div class="flex justify-center px-4">
                <div class="h-2 bg-gray-300 dark:bg-gray-600 rounded-full w-full max-w-lg">
                    <div id="weekly-review-progress" class="h-full bg-green-500 dark:bg-green-400 rounded-full transition-all" style="width: 0%"></div>
                </div>
            </div>
            <div class="flex justify-center">
                <button id="weekly-review-next-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-8 rounded-md transition shadow-lg hover:shadow-xl active:shadow-md transform hover:-translate-y-0.5 active:translate-y-0">Pr√≥ximo</button>
            </div>
        </div>
    </div>
    
    <!-- Espa√ßador para evitar que o footer cubra conte√∫do -->
    <div id="footer-spacer" class="h-48 mb-12 hidden"></div>
    
    <!-- Modal de Conclus√£o da Revis√£o -->
    <div id="review-complete-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-md transform transition-all text-center relative">
            <button id="review-complete-close" class="absolute top-4 right-4 text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white text-xl">&times;</button>
            <div class="mb-6">
                <svg class="w-16 h-16 text-green-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Parab√©ns!</h3>
                <p class="text-gray-600 dark:text-gray-400">Voc√™ completou sua revis√£o semanal com sucesso.</p>
            </div>
        </div>
    </div>

    <!-- Modal de Configura√ß√µes -->
    <div id="settings-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-md transform transition-all relative">
            <button id="settings-close" class="absolute top-4 right-4 text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white text-xl font-bold">&times;</button>
            <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">‚öôÔ∏è Configura√ß√µes</h3>
            
            <div class="space-y-6">
                <!-- Sincroniza√ß√£o com Google -->
                <div class="p-4 bg-purple-50 dark:bg-purple-900/30 rounded-lg border border-purple-200 dark:border-purple-800">
                    <div class="flex items-start gap-3">
                        <span class="text-2xl">‚òÅÔ∏è</span>
                        <div class="flex-grow">
                            <p class="font-semibold text-gray-900 dark:text-white mb-1">Sincroniza√ß√£o</p>
                            <p id="sync-status" class="text-sm text-gray-600 dark:text-gray-400 mb-3">Fa√ßa login para sincronizar seus dados entre dispositivos</p>
                            <button id="google-login-btn" class="bg-purple-600 hover:bg-purple-700 text-white text-sm font-bold py-2 px-4 rounded-md transition shadow-md hover:shadow-lg active:shadow-sm transform hover:-translate-y-0.5 active:translate-y-0 flex items-center gap-2">
                                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                </svg>
                                Login com Google
                            </button>
                            <button id="google-logout-btn" class="bg-red-600 hover:bg-red-700 text-white text-sm font-bold py-2 px-4 rounded-md transition shadow-md hover:shadow-lg active:shadow-sm transform hover:-translate-y-0.5 active:translate-y-0 hidden mt-2">
                                Sair
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Toggle de Tema -->
                <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl">üåì</span>
                        <div>
                            <p class="font-semibold text-gray-900 dark:text-white">Tema</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Alternar entre claro e escuro</p>
                        </div>
                    </div>
                    <button id="theme-toggle" class="relative inline-flex items-center h-8 rounded-full w-14 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 bg-gray-300 dark:bg-gray-600">
                        <span id="theme-toggle-dot" class="inline-block w-6 h-6 transform bg-white rounded-full transition-transform translate-x-1"></span>
                    </button>
                </div>

                <!-- Bot√£o Instalar App -->
                <div id="install-app-container" class="p-4 bg-green-50 dark:bg-green-900/30 rounded-lg border border-green-200 dark:border-green-800 hidden">
                    <div class="flex items-start gap-3">
                        <span class="text-2xl">üì±</span>
                        <div class="flex-grow">
                            <p class="font-semibold text-gray-900 dark:text-white mb-1">Instalar App</p>
                            <p id="install-app-description" class="text-sm text-gray-600 dark:text-gray-400 mb-3">Adicione o EVOMYND √† tela inicial do seu dispositivo</p>
                            <button id="install-app-btn" class="bg-green-600 hover:bg-green-700 text-white text-sm font-bold py-2 px-4 rounded-md transition shadow-md hover:shadow-lg active:shadow-sm transform hover:-translate-y-0.5 active:translate-y-0">
                                Instalar Aplicativo
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Info sobre Tutorial -->
                <div class="p-4 bg-blue-50 dark:bg-blue-900/30 rounded-lg border border-blue-200 dark:border-blue-800">
                    <div class="flex items-start gap-3">
                        <span class="text-2xl">üí°</span>
                        <div>
                            <p class="font-semibold text-gray-900 dark:text-white mb-1">Tutorial</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Precisa de ajuda para come√ßar?</p>
                            <button id="restart-tutorial-btn" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold py-2 px-4 rounded-md transition shadow-md hover:shadow-lg active:shadow-sm transform hover:-translate-y-0.5 active:translate-y-0">
                                Iniciar Tutorial
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Informa√ß√µes de Assinatura -->
                <div id="subscription-info-container" class="p-4 bg-yellow-50 dark:bg-yellow-900/30 rounded-lg border border-yellow-200 dark:border-yellow-800 hidden">
                    <div class="flex items-start gap-3">
                        <span class="text-2xl">üë§</span>
                        <div class="flex-grow">
                            <p class="font-semibold text-gray-900 dark:text-white mb-3">Minha Assinatura</p>
                            
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">Status:</span>
                                    <span id="sub-status" class="font-semibold text-gray-900 dark:text-white"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">Plano:</span>
                                    <span id="sub-plan" class="font-semibold text-gray-900 dark:text-white"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">Expira em:</span>
                                    <span id="sub-expires" class="font-semibold text-gray-900 dark:text-white"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">Dias restantes:</span>
                                    <span id="sub-days" class="font-semibold text-gray-900 dark:text-white"></span>
                                </div>
                                <div class="pt-2 border-t border-yellow-200 dark:border-yellow-700">
                                    <p class="text-xs text-gray-500 dark:text-gray-400 break-all">
                                        <strong>User ID:</strong><br>
                                        <code id="sub-userid" class="bg-gray-200 dark:bg-gray-700 px-1 py-0.5 rounded"></code>
                                    </p>
                                </div>
                            </div>
                            
                            <button id="renew-subscription-settings-btn" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white text-sm font-bold py-2 px-4 rounded-md transition shadow-md hover:shadow-lg active:shadow-sm transform hover:-translate-y-0.5 active:translate-y-0 hidden">
                                üí≥ Renovar Assinatura
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                <button id="settings-done-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-md transition shadow-lg hover:shadow-xl active:shadow-md transform hover:-translate-y-0.5 active:translate-y-0">
                    Concluir
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- ESTADO DA APLICA√á√ÉO ---
            let tasks = JSON.parse(localStorage.getItem('gtd_tasks_v2')) || [
                { id: Date.now().toString(), text: 'Marcar dentista', status: 'inbox', context: null }
            ];
            let currentView = 'inbox-view';
            let currentFilter = 'all';
            let timerInterval = null;
            let timerSeconds = 120;
            let currentTimerTask = null;
            let isTimerPaused = false;
            let pendingActionTaskId = null;
            let pendingCalendarExport = null; // Armazena dados tempor√°rios para exporta√ß√£o
            let isWeeklyReviewActive = false;
            let weeklyReviewStep = 0;
            let nextReviewDate = localStorage.getItem('next_review_date');
            let currentTheme = localStorage.getItem('theme') || 'light'; // 'light' ou 'dark'

            // Configura√ß√£o da Revis√£o Semanal
            const WEEKLY_REVIEW_STEPS = [
                { view: 'inbox-view', title: 'Passo 1/5 - Revisar Caixa de Entrada' },
                { view: 'next-actions-view', title: 'Passo 2/5 - Revisar Pr√≥ximas A√ß√µes' },
                { view: 'projects-view', title: 'Passo 3/5 - Revisar Projetos' },
                { view: 'waiting-for-view', title: 'Passo 4/5 - Revisar Aguardando' },
                { view: 'someday-maybe-view', title: 'Passo 5/5 - Revisar Algum Dia/Talvez' }
            ];
            const today = new Date().toISOString().split('T')[0];

            // --- ELEMENTOS DO DOM ---
            const app = {
                navTabs: document.querySelectorAll('.nav-tab'),
                views: document.querySelectorAll('.view'),
                newTaskInput: document.getElementById('new-task-input'),
                addTaskBtn: document.getElementById('add-task-btn'),
                inboxList: document.getElementById('inbox-list'),
                nextActionsList: document.getElementById('next-actions-list'),
                projectsList: document.getElementById('projects-list'),
                waitingForList: document.getElementById('waiting-for-list'),
                somedayMaybeList: document.getElementById('someday-maybe-list'),
                referenceList: document.getElementById('reference-list'),
                calendarList: document.getElementById('calendar-list'),
                contextFilters: document.getElementById('context-filters'),
                weeklyReview: {
                    button: document.getElementById('weekly-review-btn'),
                    footer: document.getElementById('weekly-review-footer'),
                    stepLabel: document.getElementById('weekly-review-step'),
                    progress: document.getElementById('weekly-review-progress'),
                    nextBtn: document.getElementById('weekly-review-next-btn'),
                    completeModal: document.getElementById('review-complete-modal'),
                    completeCloseBtn: document.getElementById('review-complete-close'),
                },
                timer: {
                    overlay: document.getElementById('timer-overlay'),
                    taskText: document.getElementById('timer-task-text'),
                    display: document.getElementById('timer-display'),
                    runningControls: document.getElementById('timer-running-controls'),
                    finishedControls: document.getElementById('timer-finished-controls'),
                    earlyCompleteBtn: document.getElementById('timer-early-complete-btn'),
                    pauseBtn: document.getElementById('timer-pause-btn'),
                    cancelBtn: document.getElementById('timer-cancel-btn'),
                    completeBtn: document.getElementById('timer-complete-btn'),
                    restartBtn: document.getElementById('timer-restart-btn'),
                    moveBtn: document.getElementById('timer-move-btn'),
                },
                modal: {
                    element: document.getElementById('task-modal'),
                    title: document.getElementById('modal-title'),
                    taskText: document.getElementById('modal-task-text'),
                    taskId: document.getElementById('modal-task-id'),
                    mode: document.getElementById('modal-mode'),
                    form: document.getElementById('task-form'),
                    formFields: document.getElementById('form-fields'),
                    formError: document.getElementById('form-error'),
                    cancelBtn: document.getElementById('cancel-btn'),
                    saveBtn: document.getElementById('save-btn'),
                    destinationContainer: document.getElementById('destination-container'),
                    actionsContainer: document.getElementById('modal-actions'),
                    destinationRadios: document.querySelectorAll('input[name="destination"]'),
                },
                quickActionModal: {
                    element: document.getElementById('quick-action-modal'),
                    yesBtn: document.getElementById('quick-action-yes-btn'),
                    noBtn: document.getElementById('quick-action-no-btn'),
                },
                scheduleModal: {
                    element: document.getElementById('schedule-modal'),
                    taskText: document.getElementById('schedule-task-text'),
                    dateInput: document.getElementById('schedule-date-input'),
                    timeInput: document.getElementById('schedule-time-input'),
                    endTimeInput: document.getElementById('schedule-end-time-input'),
                    saveBtn: document.getElementById('schedule-save-btn'),
                    laterBtn: document.getElementById('schedule-later-btn'),
                },
                calendarExportModal: {
                    element: document.getElementById('calendar-export-modal'),
                    yesBtn: document.getElementById('calendar-export-yes-btn'),
                    noBtn: document.getElementById('calendar-export-no-btn'),
                },
                confirmModal: {
                    element: document.getElementById('confirm-modal'),
                    text: document.getElementById('confirm-modal-text'),
                    okBtn: document.getElementById('confirm-ok-btn'),
                    cancelBtn: document.getElementById('confirm-cancel-btn'),
                },
                tutorial: {
                    modal: document.getElementById('tutorial-modal'),
                    content: document.getElementById('tutorial-content'),
                    nextBtn: document.getElementById('tutorial-next-btn'),
                    skipBtn: document.getElementById('tutorial-skip-btn'),
                },
                settings: {
                    modal: document.getElementById('settings-modal'),
                    openBtn: document.getElementById('settings-btn'),
                    closeBtn: document.getElementById('settings-close'),
                    doneBtn: document.getElementById('settings-done-btn'),
                    themeToggle: document.getElementById('theme-toggle'),
                    themeToggleDot: document.getElementById('theme-toggle-dot'),
                    restartTutorialBtn: document.getElementById('restart-tutorial-btn'),
                    installAppBtn: document.getElementById('install-app-btn'),
                    installAppContainer: document.getElementById('install-app-container'),
                    googleLoginBtn: document.getElementById('google-login-btn'),
                    googleLogoutBtn: document.getElementById('google-logout-btn'),
                    syncStatus: document.getElementById('sync-status'),
                },
                auth: {
                    loginBtn: document.getElementById('login-btn'),
                    userInfo: document.getElementById('user-info'),
                    userPhoto: document.getElementById('user-photo'),
                    userName: document.getElementById('user-name'),
                    syncStatusHeader: document.getElementById('sync-status'),
                }
            };
            
            // --- FIREBASE: AUTENTICA√á√ÉO E SINCRONIZA√á√ÉO ---
            let currentUser = null;
            let unsubscribeFirestore = null;
            let isSyncing = false;
            
            // Aguardar o Firebase carregar
            function waitForFirebase() {
                return new Promise((resolve) => {
                    if (window.firebaseAuth && window.firebaseDb) {
                        resolve();
                    } else {
                        setTimeout(() => waitForFirebase().then(resolve), 100);
                    }
                });
            }
            
            // Fun√ß√£o para atualizar UI do usu√°rio
            function updateUserUI(user) {
                if (user) {
                    // Usu√°rio logado
                    app.auth.loginBtn.classList.add('hidden');
                    app.auth.userInfo.classList.remove('hidden');
                    app.auth.userPhoto.src = user.photoURL || 'https://via.placeholder.com/32';
                    app.auth.userName.textContent = user.displayName || 'Usu√°rio';
                    
                    // Atualizar bot√µes no modal de configura√ß√µes
                    if (app.settings.googleLoginBtn) {
                        app.settings.googleLoginBtn.classList.add('hidden');
                    }
                    if (app.settings.googleLogoutBtn) {
                        app.settings.googleLogoutBtn.classList.remove('hidden');
                    }
                    if (app.settings.syncStatus) {
                        app.settings.syncStatus.textContent = `Conectado como ${user.displayName}`;
                    }
                } else {
                    // Usu√°rio deslogado
                    app.auth.loginBtn.classList.remove('hidden');
                    app.auth.userInfo.classList.add('hidden');
                    
                    // Atualizar bot√µes no modal de configura√ß√µes
                    if (app.settings.googleLoginBtn) {
                        app.settings.googleLoginBtn.classList.remove('hidden');
                    }
                    if (app.settings.googleLogoutBtn) {
                        app.settings.googleLogoutBtn.classList.add('hidden');
                    }
                    if (app.settings.syncStatus) {
                        app.settings.syncStatus.textContent = 'Fa√ßa login para sincronizar seus dados entre dispositivos';
                    }
                }
            }
            
            // --- SISTEMA DE ASSINATURA ---
            const REQUIRE_LOGIN = true; // Ativar login obrigat√≥rio
            const TRIAL_DAYS = 7; // Dias de teste gratuito
            
            // Verificar status da assinatura
            async function checkSubscription(userId) {
                try {
                    const { doc, getDoc, setDoc } = window.firebaseDbMethods;
                    const subDoc = doc(window.firebaseDb, 'subscriptions', userId);
                    const subSnapshot = await getDoc(subDoc);
                    
                    if (!subSnapshot.exists()) {
                        // Primeira vez do usu√°rio - criar per√≠odo de teste
                        console.log('üÜï Novo usu√°rio - criando per√≠odo de teste');
                        const trialEnds = new Date();
                        trialEnds.setDate(trialEnds.getDate() + TRIAL_DAYS);
                        
                        await setDoc(subDoc, {
                            userId: userId,
                            status: 'trial',
                            plan: 'trial',
                            createdAt: new Date().toISOString(),
                            trialEndsAt: trialEnds.toISOString(),
                            expiresAt: trialEnds.toISOString()
                        });
                        
                        return {
                            active: true,
                            status: 'trial',
                            expiresAt: trialEnds.toISOString(),
                            daysRemaining: TRIAL_DAYS,
                            isNewUser: true  // Flag para mostrar popup de boas-vindas
                        };
                    }
                    
                    const subscription = subSnapshot.data();
                    const expiresAt = new Date(subscription.expiresAt);
                    const now = new Date();
                    const isActive = expiresAt > now;
                    
                    if (isActive) {
                        // Calcular dias restantes
                        const daysRemaining = Math.ceil((expiresAt - now) / (1000 * 60 * 60 * 24));
                        console.log(`‚úÖ Assinatura ativa - ${daysRemaining} dias restantes`);
                        
                        return {
                            active: true,
                            status: subscription.status,
                            expiresAt: subscription.expiresAt,
                            daysRemaining: daysRemaining,
                            isNewUser: false
                        };
                    } else {
                        console.log('‚ùå Assinatura expirada');
                        return {
                            active: false,
                            status: 'expired',
                            expiresAt: subscription.expiresAt,
                            daysRemaining: 0,
                            isNewUser: false
                        };
                    }
                } catch (error) {
                    console.error('Erro ao verificar assinatura:', error);
                    // Em caso de erro, permitir acesso (fail-safe)
                    return {
                        active: true,
                        status: 'error',
                        error: error.message,
                        isNewUser: false
                    };
                }
            }
            
            // Mostrar tela de login obrigat√≥rio
            function showLoginRequired() {
                document.getElementById('login-required-screen').classList.remove('hidden');
                document.getElementById('app').style.display = 'none';
                document.getElementById('loading-screen').classList.add('hidden');
            }
            
            // Mostrar tela de assinatura expirada
            function showSubscriptionExpired(subscription) {
                const expiredScreen = document.getElementById('subscription-expired-screen');
                const expireDate = document.getElementById('subscription-expire-date');
                
                if (subscription.expiresAt) {
                    const date = new Date(subscription.expiresAt);
                    expireDate.textContent = `Expirou em: ${date.toLocaleDateString('pt-BR')}`;
                }
                
                expiredScreen.classList.remove('hidden');
                document.getElementById('app').style.display = 'none';
                document.getElementById('loading-screen').classList.add('hidden');
            }
            
            // Esconder telas de bloqueio e mostrar app
            function showApp() {
                document.getElementById('login-required-screen').classList.add('hidden');
                document.getElementById('subscription-expired-screen').classList.add('hidden');
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('app').style.display = 'block';
            }
            
            // Verificar acesso ao app
            async function verifyAccess() {
                console.log('üîê Verificando acesso...');
                
                // Se login obrigat√≥rio estiver desativado, liberar
                if (!REQUIRE_LOGIN) {
                    console.log('‚úÖ Login n√£o obrigat√≥rio - acesso liberado');
                    showApp();
                    return true;
                }
                
                // Verificar se est√° logado
                if (!currentUser) {
                    console.log('‚ö†Ô∏è Usu√°rio n√£o logado - bloqueando acesso');
                    showLoginRequired();
                    return false;
                }
                
                // Verificar assinatura
                const subscription = await checkSubscription(currentUser.uid);
                
                if (!subscription.active) {
                    console.log('‚ö†Ô∏è Assinatura inativa - bloqueando acesso');
                    showSubscriptionExpired(subscription);
                    return false;
                }
                
                // Tudo OK - liberar acesso
                console.log('‚úÖ Acesso liberado');
                showApp();
                
                // Mostrar popup de boas-vindas para novos usu√°rios
                if (subscription.isNewUser) {
                    setTimeout(() => {
                        showConfirm(
                            `üéâ Bem-vindo ao EVOMYND!\n\n` +
                            `Voc√™ ganhou ${TRIAL_DAYS} dias de teste GR√ÅTIS para experimentar todas as funcionalidades.\n\n` +
                            `üìÖ Seu per√≠odo de teste expira em: ${new Date(subscription.expiresAt).toLocaleDateString('pt-BR')}\n\n` +
                            `Aproveite para organizar suas tarefas e aumentar sua produtividade!`,
                            () => {
                                // Usu√°rio clicou em OK
                                console.log('Usu√°rio viu popup de boas-vindas');
                            },
                            'Come√ßar a usar',
                            null // Sem bot√£o de cancelar
                        );
                    }, 1000);
                }
                // Avisar se est√° em per√≠odo de teste e faltam poucos dias
                else if (subscription.status === 'trial' && subscription.daysRemaining <= 3) {
                    setTimeout(() => {
                        showConfirm(
                            `‚è∞ Aten√ß√£o!\n\n` +
                            `Seu per√≠odo de teste termina em ${subscription.daysRemaining} dia(s).\n\n` +
                            `Renove sua assinatura para continuar usando o EVOMYND sem interrup√ß√µes.`,
                            () => {
                                // Redirecionar para renova√ß√£o
                                const userId = currentUser?.uid || '';
                                const checkoutUrl = `https://mpago.la/2174QUB?external_reference=${userId}`;
                                window.open(checkoutUrl, '_blank');
                            },
                            'Renovar Agora',
                            'Depois'
                        );
                    }, 2000);
                }
                
                return true;
            }
            
            // Fun√ß√£o para sincronizar tarefas com Firestore
            async function syncToFirestore() {
                if (!currentUser || isSyncing) return;
                
                isSyncing = true;
                updateSyncStatus('Sincronizando...', 'text-yellow-600');
                
                try {
                    console.log('üîÑ Iniciando sincroniza√ß√£o...');
                    console.log('üìä Total de tarefas:', tasks.length);
                    
                    const { doc, setDoc } = window.firebaseDbMethods;
                    const userDoc = doc(window.firebaseDb, 'users', currentUser.uid);
                    
                    await setDoc(userDoc, {
                        tasks: tasks,
                        lastSync: new Date().toISOString(),
                        email: currentUser.email
                    });
                    
                    updateSyncStatus('‚úì Sincronizado', 'text-green-600');
                    console.log('‚úÖ Tarefas sincronizadas com sucesso');
                } catch (error) {
                    console.error('‚ùå Erro ao sincronizar:', error);
                    console.error('C√≥digo do erro:', error.code);
                    console.error('Mensagem:', error.message);
                    
                    // Mensagem de erro espec√≠fica
                    if (error.code === 'permission-denied') {
                        updateSyncStatus('‚ö† Sem permiss√£o', 'text-red-600');
                        console.error('‚ö†Ô∏è Configure as regras do Firestore!');
                    } else if (error.code === 'unavailable') {
                        updateSyncStatus('‚ö† Firestore offline', 'text-red-600');
                    } else {
                        updateSyncStatus('‚ö† Erro ao sincronizar', 'text-red-600');
                    }
                } finally {
                    isSyncing = false;
                }
            }
            
            // Fun√ß√£o para atualizar status de sincroniza√ß√£o
            function updateSyncStatus(text, colorClass) {
                if (app.auth.syncStatusHeader) {
                    app.auth.syncStatusHeader.textContent = text;
                    app.auth.syncStatusHeader.className = `text-xs ${colorClass} dark:${colorClass}`;
                }
            }
            
            // Fun√ß√£o para carregar tarefas do Firestore
            async function loadFromFirestore() {
                if (!currentUser) return;
                
                try {
                    console.log('üì• Carregando dados do Firestore...');
                    
                    const { doc, onSnapshot } = window.firebaseDbMethods;
                    const userDoc = doc(window.firebaseDb, 'users', currentUser.uid);
                    
                    // Listener em tempo real
                    unsubscribeFirestore = onSnapshot(userDoc, (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            console.log('üì¶ Documento encontrado:', data);
                            
                            if (data.tasks && data.tasks.length > 0) {
                                tasks = data.tasks;
                                saveTasks(); // Salvar localmente tamb√©m
                                render();
                                updateSyncStatus('‚úì Sincronizado', 'text-green-600');
                                console.log('‚úÖ Tarefas carregadas do Firestore');
                            } else {
                                console.log('üìù Documento vazio, enviando tarefas locais...');
                                syncToFirestore();
                            }
                        } else {
                            // Primeira vez do usu√°rio, fazer upload das tarefas locais
                            console.log('üÜï Primeira sincroniza√ß√£o, criando documento...');
                            syncToFirestore();
                        }
                    }, (error) => {
                        console.error('‚ùå Erro no listener:', error);
                        console.error('C√≥digo do erro:', error.code);
                        console.error('Mensagem:', error.message);
                        
                        // Mensagem de erro espec√≠fica
                        if (error.code === 'permission-denied') {
                            updateSyncStatus('‚ö† Sem permiss√£o - Configure Firestore', 'text-red-600');
                            console.error('‚ö†Ô∏è ERRO: Regras do Firestore n√£o configuradas!');
                            console.log('üìã Acesse: https://console.firebase.google.com/project/evomynd/firestore/rules');
                            console.log('üìã Cole estas regras:');
                            console.log(`
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
                            `);
                        } else {
                            updateSyncStatus('‚ö† Erro na sincroniza√ß√£o', 'text-red-600');
                        }
                    });
                } catch (error) {
                    console.error('‚ùå Erro ao carregar do Firestore:', error);
                    updateSyncStatus('‚ö† Erro ao carregar', 'text-red-600');
                }
            }
            
            // Fun√ß√£o de login
            async function loginWithGoogle() {
                try {
                    const { GoogleAuthProvider, signInWithPopup } = window.firebaseAuthMethods;
                    const provider = new GoogleAuthProvider();
                    
                    console.log('Iniciando login com Google...');
                    const result = await signInWithPopup(window.firebaseAuth, provider);
                    currentUser = result.user;
                    console.log('Login realizado:', currentUser.email);
                    updateUserUI(currentUser);
                    await loadFromFirestore();
                } catch (error) {
                    console.error('Erro completo no login:', error);
                    
                    // Mensagens de erro espec√≠ficas
                    let errorMessage = 'Erro ao fazer login. ';
                    
                    if (error.code === 'auth/popup-closed-by-user') {
                        errorMessage += 'Voc√™ fechou a janela de login. Tente novamente.';
                    } else if (error.code === 'auth/popup-blocked') {
                        errorMessage += 'O popup foi bloqueado pelo navegador. Permita popups para este site.';
                    } else if (error.code === 'auth/unauthorized-domain') {
                        errorMessage += 'Este dom√≠nio n√£o est√° autorizado. Configure o dom√≠nio no Firebase Console em:\n\nAuthentication > Settings > Authorized domains\n\nAdicione: ' + window.location.hostname;
                    } else if (error.code === 'auth/operation-not-allowed') {
                        errorMessage += 'Login com Google n√£o est√° habilitado. Ative em:\n\nFirebase Console > Authentication > Sign-in method > Google';
                    } else if (error.code === 'auth/network-request-failed') {
                        errorMessage += 'Erro de rede. Verifique sua conex√£o com a internet.';
                    } else {
                        errorMessage += error.message || 'Erro desconhecido.';
                    }
                    
                    alert(errorMessage);
                    console.log('C√≥digo do erro:', error.code);
                }
            }
            
            // Fun√ß√£o de logout
            async function logoutFromGoogle() {
                try {
                    const { signOut } = window.firebaseAuthMethods;
                    
                    // Desinscrever listener
                    if (unsubscribeFirestore) {
                        unsubscribeFirestore();
                        unsubscribeFirestore = null;
                    }
                    
                    await signOut(window.firebaseAuth);
                    currentUser = null;
                    updateUserUI(null);
                    console.log('Logout realizado');
                } catch (error) {
                    console.error('Erro no logout:', error);
                    alert('Erro ao fazer logout.');
                }
            }
            
            // Inicializar Firebase e Auth
            waitForFirebase().then(() => {
                const { onAuthStateChanged } = window.firebaseAuthMethods;
                
                // Monitorar estado de autentica√ß√£o
                onAuthStateChanged(window.firebaseAuth, async (user) => {
                    currentUser = user;
                    updateUserUI(user);
                    
                    if (user) {
                        console.log('Usu√°rio autenticado:', user.email);
                        
                        // Verificar acesso (assinatura)
                        const hasAccess = await verifyAccess();
                        
                        if (hasAccess) {
                            loadFromFirestore();
                        }
                    } else {
                        console.log('Usu√°rio n√£o autenticado');
                        // Desinscrever listener se existir
                        if (unsubscribeFirestore) {
                            unsubscribeFirestore();
                            unsubscribeFirestore = null;
                        }
                        
                        // Verificar se precisa mostrar tela de login
                        if (REQUIRE_LOGIN) {
                            showLoginRequired();
                        } else {
                            showApp();
                        }
                    }
                });
                
                // Event listeners para bot√µes de auth
                app.auth.loginBtn?.addEventListener('click', loginWithGoogle);
                app.settings.googleLoginBtn?.addEventListener('click', loginWithGoogle);
                app.settings.googleLogoutBtn?.addEventListener('click', logoutFromGoogle);
                
                // Bot√µes das telas de bloqueio
                document.getElementById('login-required-btn')?.addEventListener('click', loginWithGoogle);
                document.getElementById('logout-expired-btn')?.addEventListener('click', logoutFromGoogle);
                document.getElementById('renew-subscription-btn')?.addEventListener('click', () => {
                    // URL do checkout do Mercado Pago com identifica√ß√£o do usu√°rio
                    const userId = currentUser?.uid || '';
                    const checkoutUrl = `https://mpago.la/2174QUB?external_reference=${userId}`;
                    window.open(checkoutUrl, '_blank');
                });
            });
            
            // --- PWA: INSTALA√á√ÉO DO APP ---
            let deferredPrompt;
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            const isInStandaloneMode = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
            
            // Detectar se est√° no iOS e n√£o est√° instalado
            if (isIOS && !isInStandaloneMode) {
                // Mostrar instru√ß√µes para iOS
                app.settings.installAppContainer.classList.remove('hidden');
                const description = document.getElementById('install-app-description');
                const installBtn = app.settings.installAppBtn;
                
                description.textContent = 'Para instalar: toque no bot√£o Compartilhar ‚¨ÜÔ∏è e depois em "Adicionar √† Tela de In√≠cio"';
                installBtn.textContent = 'Ver Instru√ß√µes';
                installBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                installBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            }
            
            // Capturar o evento beforeinstallprompt (Android/Chrome/Edge)
            window.addEventListener('beforeinstallprompt', (e) => {
                // Prevenir que o navegador mostre o prompt automaticamente
                e.preventDefault();
                // Armazenar o evento para usar depois
                deferredPrompt = e;
                // Mostrar o bot√£o de instala√ß√£o
                app.settings.installAppContainer.classList.remove('hidden');
            });
            
            // Event listener para o bot√£o de instala√ß√£o
            if (app.settings.installAppBtn) {
                app.settings.installAppBtn.addEventListener('click', async () => {
                    // Se for iOS, mostrar modal com instru√ß√µes
                    if (isIOS && !deferredPrompt) {
                        const instructionsModal = document.createElement('div');
                        instructionsModal.className = 'modal-overlay fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[100]';
                        instructionsModal.innerHTML = `
                            <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-md">
                                <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">Como Instalar no iOS</h3>
                                <ol class="text-left text-gray-700 dark:text-gray-300 space-y-3 mb-6">
                                    <li class="flex gap-3">
                                        <span class="font-bold">1.</span>
                                        <span>Toque no bot√£o <strong>Compartilhar</strong> ‚¨ÜÔ∏è na barra inferior do Safari</span>
                                    </li>
                                    <li class="flex gap-3">
                                        <span class="font-bold">2.</span>
                                        <span>Role para baixo e toque em <strong>"Adicionar √† Tela de In√≠cio"</strong> ‚ûï</span>
                                    </li>
                                    <li class="flex gap-3">
                                        <span class="font-bold">3.</span>
                                        <span>Toque em <strong>"Adicionar"</strong> no canto superior direito</span>
                                    </li>
                                </ol>
                                <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-md w-full transition shadow-md hover:shadow-lg" onclick="this.closest('.modal-overlay').remove()">
                                    Entendi
                                </button>
                            </div>
                        `;
                        document.body.appendChild(instructionsModal);
                        return;
                    }
                    
                    if (!deferredPrompt) {
                        alert('O aplicativo j√° est√° instalado ou n√£o pode ser instalado neste dispositivo.');
                        return;
                    }
                    
                    // Mostrar o prompt de instala√ß√£o
                    deferredPrompt.prompt();
                    
                    // Aguardar a escolha do usu√°rio
                    const { outcome } = await deferredPrompt.userChoice;
                    
                    if (outcome === 'accepted') {
                        console.log('Usu√°rio aceitou instalar o app');
                    } else {
                        console.log('Usu√°rio recusou instalar o app');
                    }
                    
                    // Limpar o prompt
                    deferredPrompt = null;
                    // Esconder o bot√£o
                    app.settings.installAppContainer.classList.add('hidden');
                });
            }
            
            // Detectar quando o app foi instalado
            window.addEventListener('appinstalled', () => {
                console.log('EVOMYND foi instalado com sucesso!');
                app.settings.installAppContainer.classList.add('hidden');
                deferredPrompt = null;
            });
            
            // --- TEMPLATES DE FORMUL√ÅRIO ---
            const formTemplates = {
                'next-action-process': `
                    <div class="mb-4">
                        <label for="task-text-input" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Pr√≥xima A√ß√£o</label>
                        <input type="text" id="task-text-input" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="mb-4" id="context-wrapper">
                        <label for="context-input" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Contexto</label>
                        <input type="text" id="context-input" list="context-list" placeholder="Digite ou selecione um contexto (@...)" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <datalist id="context-list"></datalist>
                    </div>
                    <div class="border-t border-gray-300 dark:border-gray-600 pt-4 mt-4">
                        <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-3">üìÖ Data e Hor√°rio (obrigat√≥rio)</label>
                        <div class="mb-3">
                            <label for="due-date-input" class="block text-gray-600 dark:text-gray-400 text-xs mb-1">Data</label>
                            <input type="date" id="due-date-input" min="${today}" required class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label for="due-time-input" class="block text-gray-600 dark:text-gray-400 text-xs mb-1">Hora de In√≠cio</label>
                                <input type="time" id="due-time-input" required class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="end-time-input" class="block text-gray-600 dark:text-gray-400 text-xs mb-1">Hora de Fim</label>
                                <input type="time" id="end-time-input" required class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>`,
                'next-action-edit': `
                    <div class="mb-4">
                        <label for="task-text-input" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Pr√≥xima A√ß√£o</label>
                        <input type="text" id="task-text-input" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="mb-4" id="context-wrapper">
                        <label for="context-input" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Contexto</label>
                        <input type="text" id="context-input" list="context-list" placeholder="Digite ou selecione um contexto (@...)" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <datalist id="context-list"></datalist>
                    </div>
                    <div class="border-t border-gray-300 dark:border-gray-600 pt-4 mt-4">
                        <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-3">üìÖ Data e Hor√°rio</label>
                        <div class="mb-3">
                            <label for="due-date-input" class="block text-gray-600 dark:text-gray-400 text-xs mb-1">Data</label>
                            <input type="date" id="due-date-input" min="${today}" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label for="due-time-input" class="block text-gray-600 dark:text-gray-400 text-xs mb-1">Hora de In√≠cio</label>
                                <input type="time" id="due-time-input" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="end-time-input" class="block text-gray-600 dark:text-gray-400 text-xs mb-1">Hora de Fim</label>
                                <input type="time" id="end-time-input" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>`,
                'project': `<div class="mb-4">
                                <label for="task-text-input" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Nome do Projeto</label>
                                <input type="text" id="task-text-input" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="mt-4">
                                <label for="due-date-input" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Data de Conclus√£o</label>
                                <input type="date" id="due-date-input" min="${today}" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>`,
                'waiting': `<div class="mb-4">
                                <label for="task-text-input" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Aguardando por</label>
                                <input type="text" id="task-text-input" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="grid grid-cols-2 gap-4 mt-4">
                                <div>
                                    <label for="due-date-input" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Data de Acompanhamento</label>
                                    <input type="date" id="due-date-input" min="${today}" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="due-time-input" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Hora</label>
                                    <input type="time" id="due-time-input" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>`,
                'someday': `<div class="mb-4"><label for="task-text-input" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Ideia</label><input type="text" id="task-text-input" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500"></div>`,
                'reference': `<div class="mb-4"><label for="task-text-input" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Refer√™ncia</label><textarea id="task-text-input" rows="4" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea></div>`
            };


            // --- FUN√á√ïES ---
            const statusInfo = { 'inbox': { icon: 'üì•', color: 'border-gray-500', name: 'Caixa de Entrada' }, 'next-action': { icon: '‚û°Ô∏è', color: 'border-blue-500', name: 'Pr√≥xima A√ß√£o' }, 'project': { icon: 'üìÇ', color: 'border-purple-500', name: 'Projeto' }, 'waiting': { icon: '‚è≥', color: 'border-yellow-500', name: 'Aguardando' }, 'someday': { icon: 'üí°', color: 'border-teal-500', name: 'Algum Dia/Talvez' }, 'reference': { icon: 'üìã', color: 'border-gray-400', name: 'Refer√™ncia' }};

            const getExistingContexts = () => {
                return [...new Set(tasks
                    .filter(t => t.status === 'next-action' && t.context)
                    .map(t => t.context))
                ].sort();
            };

            const saveTasks = () => {
                localStorage.setItem('gtd_tasks_v2', JSON.stringify(tasks));
                // Sincronizar com Firebase se usu√°rio estiver logado (com debounce)
                if (currentUser && !isSyncing) {
                    // Usar debounce para evitar sincroniza√ß√µes excessivas
                    clearTimeout(window.syncTimeout);
                    window.syncTimeout = setTimeout(() => {
                        syncToFirestore();
                    }, 1000); // Aguarda 1 segundo de inatividade antes de sincronizar
                }
            };

            const findTask = (id) => tasks.find(t => t.id === id);

            const render = () => {
                // N√£o precisa chamar saveTasks aqui - j√° √© chamado quando necess√°rio
                const renderMap = {
                    'inbox-view': renderInbox,
                    'next-actions-view': renderNextActions,
                    'projects-view': () => renderListByStatus('project', app.projectsList, 'Nenhum projeto ativo.'),
                    'waiting-for-view': () => renderListByStatus('waiting', app.waitingForList, 'N√£o est√° a aguardar por nada.'),
                    'someday-maybe-view': () => renderListByStatus('someday', app.somedayMaybeList, 'A sua lista de "Algum Dia" est√° vazia.'),
                    'reference-view': () => renderListByStatus('reference', app.referenceList, 'Nenhum material de refer√™ncia guardado.'),
                    'calendar-view': renderCalendar,
                };
                
                if (currentView in renderMap) {
                    renderMap[currentView]();
                }
                
                if (currentView === 'next-actions-view') renderContextFilters();
                updateActiveView();
            };

            // --- GERENCIAMENTO DE TEMA ---
            const applyTheme = (theme) => {
                const html = document.documentElement;
                
                if (theme === 'dark') {
                    html.classList.add('dark');
                } else {
                    html.classList.remove('dark');
                }
                
                // Atualiza meta theme-color
                const metaTheme = document.querySelector('meta[name="theme-color"]');
                if (metaTheme) {
                    metaTheme.content = theme === 'dark' ? '#111827' : '#ffffff';
                }

                // Salva prefer√™ncia
                localStorage.setItem('theme', theme);
                currentTheme = theme;

                // Atualiza toggle visual
                if (theme === 'dark') {
                    app.settings.themeToggle.classList.remove('bg-gray-300');
                    app.settings.themeToggle.classList.add('bg-blue-600');
                    app.settings.themeToggleDot.classList.remove('translate-x-1');
                    app.settings.themeToggleDot.classList.add('translate-x-7');
                } else {
                    app.settings.themeToggle.classList.remove('bg-blue-600');
                    app.settings.themeToggle.classList.add('bg-gray-300');
                    app.settings.themeToggleDot.classList.remove('translate-x-7');
                    app.settings.themeToggleDot.classList.add('translate-x-1');
                }
            };

            const toggleTheme = () => {
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                applyTheme(newTheme);
            };
            
            const createTaskItemHTML = (task, options = {}) => {
                const currentStatus = statusInfo[task.status] || statusInfo['inbox'];
                const isProject = task.status === 'project';
                
                const inboxActionsHTML = `
                    <div class="flex gap-2">
                        <button data-id="${task.id}" class="process-btn bg-green-600 hover:bg-green-700 text-white text-sm font-bold py-1 px-3 rounded-md inline-flex items-center shadow-md hover:shadow-lg active:shadow-sm transform hover:-translate-y-0.5 active:translate-y-0 transition">
                            Processar
                        </button>
                        <button data-id="${task.id}" class="do-now-btn bg-yellow-600 hover:bg-yellow-700 text-white text-sm font-bold py-1 px-3 rounded-md inline-flex items-center shadow-md hover:shadow-lg active:shadow-sm transform hover:-translate-y-0.5 active:translate-y-0 transition" title="Fazer agora (menos de 2 minutos)">
                            ‚ö° Fazer agora
                        </button>
                    </div>`;

                const mainItemHTML = `
                    <div class="task-item bg-white dark:bg-gray-800 p-4 ${isProject ? 'rounded-t-lg' : 'rounded-lg'} shadow-md flex flex-col sm:flex-row justify-between sm:items-start border-l-4 ${currentStatus.color} transition-all duration-300 border border-gray-200 dark:border-gray-700">
                        <div class="flex items-start gap-4 flex-grow min-w-0">
                           <div class="text-lg font-mono text-gray-600 dark:text-gray-400 w-8 text-center flex-shrink-0 pt-1">${currentStatus.icon}</div>
                           <div class="flex-grow min-w-0">
                                <span class="text-gray-900 dark:text-gray-300 break-words">${task.text}</span>
                                ${task.context ? `<p class="text-xs text-blue-600 dark:text-blue-400 mt-1 break-words">${task.context}</p>` : ''}
                                ${task.dueDate ? (() => {
                                    const taskDateTime = new Date(`${task.dueDate}T${task.dueTime || '23:59'}`);
                                    const now = new Date();
                                    const isOverdue = taskDateTime < now;
                                    const dateColor = isOverdue ? 'text-red-600 dark:text-red-400' : 'text-cyan-600 dark:text-cyan-400';
                                    const dateDecoration = isOverdue ? 'line-through' : '';
                                    return `
                                    <p class="text-xs ${dateColor} mt-1 flex items-center gap-1 flex-wrap">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                                        <span class="break-words ${dateDecoration}">${new Date(task.dueDate + 'T00:00:00').toLocaleDateString('pt-BR')} ${task.dueTime || ''}</span>
                                        ${isOverdue ? '<span class="font-bold ml-1">‚ö†Ô∏è VENCIDA</span>' : ''}
                                    </p>`;
                                })() : ''}
                           </div>
                        </div>
                        <div class="flex items-center gap-2 mt-4 sm:mt-0 sm:ml-4 flex-wrap justify-end flex-shrink-0">
                             ${isProject ? `<button data-id="${task.id}" class="toggle-subtasks-btn bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold py-1 px-3 rounded-md shadow-md hover:shadow-lg active:shadow-sm transform hover:-translate-y-0.5 active:translate-y-0 transition">A√ß√µes</button>` : ''}
                            ${task.status === 'inbox' ? inboxActionsHTML : ''}
                            ${task.status !== 'inbox' ? `<button data-id="${task.id}" class="edit-btn bg-yellow-600 hover:bg-yellow-700 text-white text-sm font-bold py-1 px-3 rounded-md shadow-md hover:shadow-lg active:shadow-sm transform hover:-translate-y-0.5 active:translate-y-0 transition">Editar</button>` : ''}
                            ${task.status === 'next-action' ? `<button data-id="${task.id}" class="done-btn bg-green-600 hover:bg-green-700 text-white text-sm font-bold py-1 px-3 rounded-md shadow-md hover:shadow-lg active:shadow-sm transform hover:-translate-y-0.5 active:translate-y-0 transition">Concluir</button>` : ''}
                            <button data-id="${task.id}" class="delete-btn bg-red-600 hover:bg-red-700 text-white text-sm font-bold py-1 px-3 rounded-md shadow-md hover:shadow-lg active:shadow-sm transform hover:-translate-y-0.5 active:translate-y-0 transition">Apagar</button>
                        </div>
                    </div>
                `;
                
                if (isProject) { 
                    return `<div class="mb-4">${mainItemHTML}<div id="subtasks-container-${task.id}" class="subtasks-container hidden bg-gray-100 dark:bg-gray-800/60 rounded-b-lg p-4 -mt-2 border border-t-0 border-gray-200 dark:border-gray-700"></div></div>`; 
                } else { 
                    return `<div class="mb-4">${mainItemHTML}</div>`; 
                }
            };

            const renderSubTasks = (projectId) => { 
                const project = findTask(projectId); 
                const container = document.getElementById(`subtasks-container-${projectId}`); 
                if (!project || !container) return; 
                
                // Ordenar: n√£o conclu√≠das primeiro (por data crescente), depois conclu√≠das
                project.subTasks.sort((a, b) => {
                    // Primeiro, separar por status de conclus√£o
                    if (a.completed !== b.completed) {
                        return a.completed - b.completed;
                    }
                    
                    // Se ambas n√£o conclu√≠das ou ambas conclu√≠das, ordenar por data
                    if (!a.dueDate && !b.dueDate) return 0;
                    if (!a.dueDate) return 1; // Sem data vai para o final
                    if (!b.dueDate) return -1;
                    
                    // Comparar datas e hor√°rios
                    const dateA = new Date(`${a.dueDate}T${a.dueTime || '00:00'}`);
                    const dateB = new Date(`${b.dueDate}T${b.dueTime || '00:00'}`);
                    return dateA - dateB;
                });
                
                const subTasksHTML = project.subTasks.map(subtask => {
                    // Verificar se est√° vencida
                    const isOverdue = subtask.dueDate && subtask.dueTime && subtask.endTime && 
                                      new Date(`${subtask.dueDate}T${subtask.endTime}`) < new Date();
                    const dateClass = isOverdue ? 'text-red-600 dark:text-red-400 line-through' : 'text-gray-700 dark:text-white';
                    
                    return `
                    <div class="subtask-item flex items-start gap-3 p-3 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700/50 min-w-0 border border-gray-200 dark:border-gray-700">
                        <input type="checkbox" ${subtask.completed ? 'checked' : ''} data-project-id="${projectId}" data-subtask-id="${subtask.id}" class="subtask-checkbox h-5 w-5 bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded text-blue-500 focus:ring-blue-600 cursor-pointer flex-shrink-0 mt-1">
                        <div class="flex-grow min-w-0">
                            <span class="text-gray-700 dark:text-gray-400 break-words ${subtask.completed ? 'line-through text-gray-500' : ''}">${subtask.text}</span>
                            ${subtask.dueDate ? `
                                <div class="text-xs ${dateClass} mt-1">
                                    üìÖ ${new Date(subtask.dueDate + 'T00:00:00').toLocaleDateString('pt-BR')} 
                                    ${subtask.dueTime || ''} 
                                    ${subtask.endTime ? ` - ${subtask.endTime}` : ''}
                                    ${isOverdue ? ' ‚ö†Ô∏è VENCIDA' : ''}
                                </div>
                            ` : ''}
                        </div>
                        <button data-project-id="${projectId}" data-subtask-id="${subtask.id}" class="delete-subtask-btn text-gray-500 hover:text-red-500 text-xl flex-shrink-0">&times;</button>
                    </div>
                `;
                }).join(''); 
                
                const formHTML = `
                    <div class="add-subtask-form mt-4 pt-4 border-t border-gray-300 dark:border-gray-700/50 bg-gray-50 dark:bg-gray-900/30 p-4 rounded-md">
                        <h5 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">‚ûï Nova A√ß√£o do Projeto</h5>
                        <input type="text" data-project-id="${projectId}" class="new-subtask-input w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-gray-700 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 mb-3" placeholder="Descreva a a√ß√£o...">
                        
                        <div class="mb-3">
                            <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">Data *</label>
                            <input type="date" data-project-id="${projectId}" class="subtask-due-date w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-gray-700 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500" min="${today}" required>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div>
                                <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">Hora In√≠cio *</label>
                                <input type="time" data-project-id="${projectId}" class="subtask-start-time w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-gray-700 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">Hora Fim *</label>
                                <input type="time" data-project-id="${projectId}" class="subtask-end-time w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 text-gray-700 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                        </div>
                        
                        <button data-project-id="${projectId}" class="add-subtask-btn w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md shadow-md hover:shadow-lg active:shadow-sm transform hover:-translate-y-0.5 active:translate-y-0 transition">Adicionar A√ß√£o</button>
                    </div>
                `; 
                
                container.innerHTML = `<h4 class="text-sm font-bold text-gray-700 dark:text-gray-400 mb-2">A√ß√µes do Projeto</h4><div class="space-y-2">${project.subTasks.length > 0 ? subTasksHTML : '<p class="text-gray-600 dark:text-gray-500 text-sm py-2">Nenhuma a√ß√£o adicionada a este projeto.</p>'}</div>${formHTML}`; 
            };
            
            const renderListByStatus = (status, element, emptyMessage, options = {}) => { 
                let filteredTasks = tasks.filter(t => t.status === status);
                
                // Ordenar projetos por data de conclus√£o crescente
                if (status === 'project') {
                    filteredTasks.sort((a, b) => {
                        // Se nenhum tem data, manter ordem original
                        if (!a.dueDate && !b.dueDate) return 0;
                        // Se 'a' n√£o tem data, vai para o final
                        if (!a.dueDate) return 1;
                        // Se 'b' n√£o tem data, 'a' vem primeiro
                        if (!b.dueDate) return -1;
                        // Ambos t√™m data, ordenar por data crescente
                        const dateA = new Date(a.dueDate + 'T00:00:00');
                        const dateB = new Date(b.dueDate + 'T00:00:00');
                        return dateA - dateB;
                    });
                }
                
                if (filteredTasks.length === 0) { 
                    element.innerHTML = `<div class="text-center py-10 px-6 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700"><p class="text-gray-600 dark:text-gray-400">${emptyMessage}</p></div>`; 
                } else { 
                    element.innerHTML = filteredTasks.map(task => createTaskItemHTML(task, options)).join(''); 
                }
            };
            
            const renderInbox = () => renderListByStatus('inbox', app.inboxList, 'A sua caixa de entrada est√° vazia. Capture algo!');
            
            const renderNextActions = () => { 
                let nextActionsTasks = tasks.filter(t => t.status === 'next-action'); 
                if (currentFilter !== 'all') { 
                    nextActionsTasks = nextActionsTasks.filter(t => t.context === currentFilter); 
                }
                
                // Ordenar: sem data primeiro, depois por data crescente
                nextActionsTasks.sort((a, b) => {
                    // Se nenhum tem data, manter ordem original
                    if (!a.dueDate && !b.dueDate) return 0;
                    // Se 'a' n√£o tem data, vem primeiro
                    if (!a.dueDate) return -1;
                    // Se 'b' n√£o tem data, 'a' vem depois
                    if (!b.dueDate) return 1;
                    // Ambos t√™m data, ordenar por data/hora
                    const dateA = new Date(`${a.dueDate}T${a.dueTime || '00:00'}`);
                    const dateB = new Date(`${b.dueDate}T${b.dueTime || '00:00'}`);
                    return dateA - dateB;
                });
                
                if (nextActionsTasks.length === 0) { 
                    app.nextActionsList.innerHTML = `<div class="text-center py-10 px-6 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700"><p class="text-gray-600 dark:text-gray-400">${currentFilter === 'all' ? 'Nenhuma pr√≥xima a√ß√£o definida.' : `Nenhuma a√ß√£o com o contexto ${currentFilter}.`}</p></div>`; 
                } else { 
                    app.nextActionsList.innerHTML = nextActionsTasks.map(createTaskItemHTML).join(''); 
                } 
            };
            
            const renderCalendar = () => {
                const scheduledTasks = tasks
                    .filter(t => t.dueDate)
                    .sort((a, b) => {
                        const dateA = new Date(`${a.dueDate}T${a.dueTime || '00:00'}`);
                        const dateB = new Date(`${b.dueDate}T${b.dueTime || '00:00'}`);
                        return dateA - dateB;
                    });

                if (scheduledTasks.length === 0) {
                    app.calendarList.innerHTML = `<div class="text-center py-10 px-6 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700"><p class="text-gray-600 dark:text-gray-400">Nenhum item agendado no calend√°rio.</p></div>`;
                    return;
                }

                const tasksByDate = scheduledTasks.reduce((acc, task) => {
                    const date = task.dueDate;
                    if (!acc[date]) {
                        acc[date] = [];
                    }
                    acc[date].push(task);
                    return acc;
                }, {});

                let html = '';
                for (const date in tasksByDate) {
                    const dateObj = new Date(date + 'T00:00:00');
                    const dayName = dateObj.toLocaleDateString('pt-BR', { weekday: 'long' });
                    const formattedDate = dateObj.toLocaleDateString('pt-BR', { day: '2-digit', month: 'long' });

                    html += `
                        <div class="mb-6">
                            <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-3">${dayName}, <span class="text-gray-600 dark:text-gray-400">${formattedDate}</span></h3>
                            <div class="space-y-2">
                                ${tasksByDate[date].map(task => {
                                    // Mostrar hor√°rio de in√≠cio e fim se dispon√≠vel
                                    let timeDisplay = '';
                                    if (task.dueTime && task.endTime) {
                                        timeDisplay = `<span class="font-semibold text-gray-700 dark:text-gray-300 w-auto text-right whitespace-nowrap">${task.dueTime} - ${task.endTime}</span>`;
                                    } else if (task.dueTime) {
                                        timeDisplay = `<span class="font-semibold text-gray-700 dark:text-gray-300 w-16 text-right">${task.dueTime}</span>`;
                                    } else {
                                        timeDisplay = `<span class="w-16"></span>`;
                                    }
                                    
                                    const colorClass = (statusInfo[task.status]?.color || 'border-gray-500').replace('border-', 'bg-');
                                    const statusName = statusInfo[task.status]?.name || task.status;
                                    
                                    // Criar link para Google Calendar
                                    const startDateTime = task.dueTime 
                                        ? `${task.dueDate.replace(/-/g, '')}T${task.dueTime.replace(':', '')}00`
                                        : `${task.dueDate.replace(/-/g, '')}`;
                                    
                                    // Usar endTime se dispon√≠vel, sen√£o adicionar 1 hora ao hor√°rio de in√≠cio
                                    let endDateTime;
                                    if (task.endTime) {
                                        endDateTime = `${task.dueDate.replace(/-/g, '')}T${task.endTime.replace(':', '')}00`;
                                    } else if (task.dueTime) {
                                        // Adicionar 1 hora ao hor√°rio de in√≠cio
                                        const [hours, minutes] = task.dueTime.split(':');
                                        const endHour = (parseInt(hours) + 1).toString().padStart(2, '0');
                                        endDateTime = `${task.dueDate.replace(/-/g, '')}T${endHour}${minutes}00`;
                                    } else {
                                        endDateTime = `${task.dueDate.replace(/-/g, '')}`;
                                    }
                                    
                                    const googleCalendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(task.text)}&dates=${startDateTime}/${endDateTime}&details=${encodeURIComponent('Criado no EVOMYND')}`;
                                    
                                    return `
                                        <div class="flex items-center gap-3 bg-white dark:bg-gray-800 p-3 rounded-lg border border-gray-200 dark:border-gray-700 min-w-0">
                                            ${timeDisplay}
                                            <div class="w-1 h-8 ${colorClass} rounded-full flex-shrink-0"></div>
                                            <span class="text-gray-700 dark:text-gray-300 break-words flex-grow min-w-0">${task.text}</span>
                                            <a href="${googleCalendarUrl}" target="_blank" rel="noopener noreferrer" class="flex-shrink-0 text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 transition" title="Adicionar ao Google Calendar">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                    <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
                                                </svg>
                                            </a>
                                            <span class="text-xs text-gray-600 dark:text-gray-400 flex-shrink-0 whitespace-nowrap">(${statusName})</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
                app.calendarList.innerHTML = html;
            };

            const renderContextFilters = () => { 
                const contexts = getExistingContexts();
                
                // Criar dropdown ao inv√©s de bot√µes
                let filtersHTML = `
                    <div class="relative inline-block w-full sm:w-64">
                        <label for="context-filter-select" class="block text-gray-700 dark:text-gray-300 text-xs font-semibold mb-1">Filtrar por contexto:</label>
                        <select id="context-filter-select" class="w-full bg-white dark:bg-gray-700 border-2 border-gray-300 dark:border-gray-600 rounded-lg py-2 px-4 text-gray-900 dark:text-white font-semibold focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            <option value="all" ${currentFilter === 'all' ? 'selected' : ''}>üìã Todos os contextos</option>
                            ${contexts.map(context => 
                                `<option value="${context}" ${currentFilter === context ? 'selected' : ''}>${context}</option>`
                            ).join('')}
                        </select>
                    </div>
                `; 
                
                app.contextFilters.innerHTML = filtersHTML;
                
                // Adicionar event listener ao select
                const selectElement = document.getElementById('context-filter-select');
                if (selectElement) {
                    selectElement.addEventListener('change', (e) => {
                        currentFilter = e.target.value;
                        render();
                    });
                }
            };
            
            const updateActiveView = () => {
                app.views.forEach(view => view.id === currentView ? view.classList.remove('hidden') : view.classList.add('hidden'));
                app.navTabs.forEach(tab => {
                    if (tab.dataset.view === currentView) {
                        tab.classList.add('bg-blue-600', 'text-white');
                        tab.classList.remove('bg-white', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300', 'hover:bg-gray-100', 'dark:hover:bg-gray-700');
                    } else {
                        tab.classList.remove('bg-blue-600', 'text-white');
                        tab.classList.add('bg-white', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300', 'hover:bg-gray-100', 'dark:hover:bg-gray-700');
                    }
                });
            };
            
            const addTask = () => { 
                const text = app.newTaskInput.value.trim(); 
                if (text) { 
                    tasks.unshift({ id: Date.now().toString(), text: text, status: 'inbox', context: null, dueDate: null, dueTime: null }); 
                    app.newTaskInput.value = ''; 
                    render(); 
                } 
            };
            
            const showConfirm = (message, onConfirm, okText = 'OK', cancelText = 'Cancelar') => { 
                app.confirmModal.text.textContent = message; 
                app.confirmModal.okBtn.textContent = okText;
                app.confirmModal.cancelBtn.textContent = cancelText;
                app.confirmModal.element.classList.remove('hidden'); 
                const okListener = () => { onConfirm(); hideConfirm(); }; 
                const cancelListener = () => { hideConfirm(); }; 
                const hideConfirm = () => { 
                    app.confirmModal.element.classList.add('hidden'); 
                    app.confirmModal.okBtn.removeEventListener('click', okListener); 
                    app.confirmModal.cancelBtn.removeEventListener('click', cancelListener);
                    // Resetar textos padr√£o
                    app.confirmModal.okBtn.textContent = 'OK';
                    app.confirmModal.cancelBtn.textContent = 'Cancelar';
                }; 
                app.confirmModal.okBtn.addEventListener('click', okListener, { once: true }); 
                app.confirmModal.cancelBtn.addEventListener('click', cancelListener, { once: true }); 
            };
            
            const directProcessTask = (id, destination) => {
                const task = findTask(id);
                if (task) {
                    task.status = destination;
                    if (destination === 'project' && !task.subTasks) {
                        task.subTasks = [];
                    }
                    task.context = null;
                    saveTasks();
                    render();
                }
            };
            
            const openTaskModal = (task, mode = 'process') => {
                app.modal.title.textContent = mode === 'process' ? 'Processar Item' : 'Editar / Mover Item';
                app.modal.taskId.value = task.id;
                app.modal.mode.value = mode;
                
                // Salvar valores originais para compara√ß√£o posterior
                document.getElementById('original-due-date').value = task.dueDate || '';
                document.getElementById('original-due-time').value = task.dueTime || '';
                document.getElementById('original-end-time').value = task.endTime || '';
                
                app.modal.destinationContainer.style.display = 'block';

                if (mode === 'process') {
                    app.modal.taskText.textContent = task.text;
                    app.modal.taskText.classList.remove('hidden');
                    app.modal.form.elements.destination.value = 'next-action';
                    updateModalForm('next-action', task, mode);
                } else { // 'edit' mode
                    app.modal.taskText.classList.add('hidden');
                    const destination = task.status;
                    app.modal.form.elements.destination.value = destination;
                    updateModalForm(destination, task, mode);
                }
                
                // Atualizar estilos dos bot√µes do modal
                app.modal.destinationRadios.forEach(r => {
                    const label = r.parentElement;
                    if (r.checked) {
                        label.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-white');
                        label.classList.add('bg-blue-600', 'text-white');
                    } else {
                        label.classList.remove('bg-blue-600', 'text-white');
                        label.classList.add('bg-gray-100', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-white');
                    }
                });
                
                app.modal.element.classList.remove('hidden');
            };
            
            const updateModalForm = (destination, task, mode) => {
                let template = formTemplates[destination];
                if(destination === 'next-action'){
                    template = mode === 'process' ? formTemplates['next-action-process'] : formTemplates['next-action-edit'];
                }
                app.modal.formFields.innerHTML = template;
                
                const textInput = document.getElementById('task-text-input');
                if (textInput) {
                    textInput.value = task.text; textInput.focus();
                }
                if (destination === 'next-action' || destination === 'waiting' || destination === 'project') {
                    const dueDateInput = document.getElementById('due-date-input');
                    const dueTimeInput = document.getElementById('due-time-input');
                    const endTimeInput = document.getElementById('end-time-input');
                    if(dueDateInput) dueDateInput.value = task.dueDate || '';
                    if(dueTimeInput) dueTimeInput.value = task.dueTime || '';
                    if(endTimeInput) endTimeInput.value = task.endTime || '';
                }
                if (destination === 'next-action') {
                    const contextInput = document.getElementById('context-input');
                    contextInput.value = task.context || '';
                    document.getElementById('context-list').innerHTML = getExistingContexts().map(c => `<option value="${c}"></option>`).join('');
                }
            };

            const closeModal = () => { 
                app.modal.element.classList.add('hidden'); 
                app.modal.formError.textContent = '';
            };

            const saveTask = (e) => { 
                e.preventDefault(); 
                const id = app.modal.taskId.value; 
                const mode = app.modal.mode.value;
                const task = findTask(id); 
                if (!task) return; 
                const destination = app.modal.form.elements.destination.value; 
                let text, context, isValid = true; 
                app.modal.formError.textContent = ''; 
                text = document.getElementById('task-text-input')?.value.trim(); 
                if (!text) isValid = false;
                
                const dueDateInput = document.getElementById('due-date-input');
                const dueTimeInput = document.getElementById('due-time-input');
                const endTimeInput = document.getElementById('end-time-input');

                // Validar campos obrigat√≥rios para processar inbox (modo process)
                if (destination === 'next-action' && mode === 'process') {
                    if (!dueDateInput?.value) {
                        app.modal.formError.textContent = 'Data √© obrigat√≥ria ao processar item.';
                        return;
                    }
                    if (!dueTimeInput?.value) {
                        app.modal.formError.textContent = 'Hora de in√≠cio √© obrigat√≥ria ao processar item.';
                        return;
                    }
                    if (!endTimeInput?.value) {
                        app.modal.formError.textContent = 'Hora de fim √© obrigat√≥ria ao processar item.';
                        return;
                    }
                    
                    // Validar que data/hora n√£o √© no passado
                    const now = new Date();
                    const selectedDateTime = new Date(`${dueDateInput.value}T${dueTimeInput.value}`);
                    
                    if (selectedDateTime < now) {
                        app.modal.formError.textContent = 'N√£o √© poss√≠vel agendar para data/hora passada. Escolha hor√°rio futuro.';
                        return;
                    }
                    
                    // Validar que hora de fim √© depois da hora de in√≠cio
                    if (dueTimeInput.value && endTimeInput.value && endTimeInput.value <= dueTimeInput.value) {
                        app.modal.formError.textContent = 'Hora de fim deve ser depois da hora de in√≠cio.';
                        return;
                    }
                }
                
                // Validar data de conclus√£o obrigat√≥ria para projetos no modo process
                if (destination === 'project' && mode === 'process') {
                    if (!dueDateInput?.value) {
                        app.modal.formError.textContent = 'Data de conclus√£o √© obrigat√≥ria ao criar um projeto.';
                        return;
                    }
                    if (dueDateInput.value < today) {
                        app.modal.formError.textContent = 'Data de conclus√£o n√£o pode ser no passado.';
                        return;
                    }
                }
                
                // Para modo edit ou outras destina√ß√µes, validar apenas data se fornecida
                if (mode === 'edit' && dueDateInput && dueDateInput.value && dueDateInput.value < today) {
                    app.modal.formError.textContent = 'N√£o √© poss√≠vel agendar para uma data passada.';
                    return;
                }

                task.dueDate = dueDateInput ? dueDateInput.value : null;
                task.dueTime = dueTimeInput ? dueTimeInput.value : null;
                task.endTime = endTimeInput ? endTimeInput.value : null;

                switch (destination) { 
                    case 'next-action':
                        context = document.getElementById('context-input').value.trim(); 
                        if (!context) isValid = false; 
                        if (context && !context.startsWith('@')) context = '@' + context; 
                        task.context = context;
                        break; 
                    default: 
                        task.context = null; 
                        break; 
                } 
                if (isValid) { 
                    task.text = text; 
                    task.status = destination; 
                    if (destination === 'project' && !task.subTasks) { 
                        task.subTasks = []; 
                    }
                    saveTasks();
                    closeModal(); 
                    render();
                    
                    // Perguntar se quer adicionar ao calend√°rio
                    // - Modo process: sempre perguntar se tiver data/hora/endTime
                    // - Modo edit: perguntar se editou a data/hora e tem todos os campos preenchidos
                    const originalDate = document.getElementById('original-due-date').value;
                    const originalTime = document.getElementById('original-due-time').value;
                    const originalEndTime = document.getElementById('original-end-time').value;
                    
                    const dateChanged = task.dueDate !== originalDate || task.dueTime !== originalTime || task.endTime !== originalEndTime;
                    const hasAllFields = task.dueDate && task.dueTime && task.endTime;
                    
                    const shouldAskCalendar = destination === 'next-action' && hasAllFields && (mode === 'process' || dateChanged);
                    
                    if (shouldAskCalendar) {
                        showCalendarPrompt(task);
                    }
                } else { 
                    app.modal.formError.textContent = 'Por favor, preencha todos os campos necess√°rios.'; 
                } 
            };
            
            // Fun√ß√£o para perguntar se quer adicionar ao calend√°rio
            const showCalendarPrompt = (task) => {
                const message = `‚úÖ Tarefa processada com sucesso!\n\nüìÖ Deseja adicionar "${task.text}" ao seu calend√°rio pessoal?\n\nData: ${new Date(task.dueDate + 'T00:00:00').toLocaleDateString('pt-BR')}\nIn√≠cio: ${task.dueTime}\nFim: ${task.endTime}`;
                
                showConfirm(message, () => {
                    // Usu√°rio clicou em "OK" - exportar para calend√°rio
                    exportTaskToGoogleCalendar(task);
                }, 'Adicionar ao Calend√°rio', 'N√£o, obrigado');
            };
            
            // Fun√ß√£o para exportar tarefa para Google Calendar
            const exportTaskToGoogleCalendar = (task) => {
                if (!task.dueDate) return;
                
                let startDateTime, endDateTime;
                
                if (task.dueTime) {
                    startDateTime = `${task.dueDate.replace(/-/g, '')}T${task.dueTime.replace(':', '')}00`;
                } else {
                    startDateTime = `${task.dueDate.replace(/-/g, '')}`;
                }
                
                if (task.endTime) {
                    endDateTime = `${task.dueDate.replace(/-/g, '')}T${task.endTime.replace(':', '')}00`;
                } else if (task.dueTime) {
                    // Adicionar 1 hora ao hor√°rio de in√≠cio se n√£o tiver hora de fim
                    const [hours, minutes] = task.dueTime.split(':');
                    const endHour = (parseInt(hours) + 1).toString().padStart(2, '0');
                    endDateTime = `${task.dueDate.replace(/-/g, '')}T${endHour}${minutes}00`;
                } else {
                    endDateTime = `${task.dueDate.replace(/-/g, '')}`;
                }
                
                const googleCalendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(task.text)}&dates=${startDateTime}/${endDateTime}&details=${encodeURIComponent('Criado no EVOMYND' + (task.context ? ' - ' + task.context : ''))}`;
                
                window.open(googleCalendarUrl, '_blank', 'noopener,noreferrer');
            };

            const deleteTask = (id) => { 
                showConfirm('Tem certeza que deseja apagar este item?', () => { 
                    tasks = tasks.filter(t => t.id !== id);
                    saveTasks();
                    render(); 
                }); 
            };
            
            // --- L√≥gica do Timer ---
            const startTimer = () => {
                stopTimer();
                isTimerPaused = false;
                app.timer.pauseBtn.textContent = 'Pausar';
                timerSeconds = 120;
                
                // Se currentTimerTask j√° foi setado (bot√£o "Fazer agora"), usar ele
                // Caso contr√°rio, buscar pela taskId (modal ou pendingActionTaskId)
                if (!currentTimerTask) {
                    const taskId = pendingActionTaskId || app.modal.taskId.value;
                    currentTimerTask = findTask(taskId);
                }
                
                if (!currentTimerTask) {
                    console.error('Tarefa n√£o encontrada para iniciar timer');
                    return;
                }
                
                // Remover a tarefa da lista apenas se ela ainda existir
                if (tasks.some(t => t.id === currentTimerTask.id)) {
                     tasks = tasks.filter(t => t.id !== currentTimerTask.id);
                     saveTasks();
                }
                render();

                app.timer.taskText.textContent = currentTimerTask.text;
                app.timer.overlay.classList.remove('hidden');
                app.timer.overlay.classList.add('flex');
                app.timer.finishedControls.classList.add('hidden');
                app.timer.runningControls.classList.remove('hidden');
                
                const updateDisplay = () => {
                    const minutes = Math.floor(timerSeconds / 60).toString().padStart(2, '0');
                    const seconds = (timerSeconds % 60).toString().padStart(2, '0');
                    app.timer.display.textContent = `${minutes}:${seconds}`;
                };
                updateDisplay();

                timerInterval = setInterval(() => {
                    timerSeconds--;
                    updateDisplay();
                    if (timerSeconds <= 0) {
                        stopTimer();
                        app.timer.finishedControls.classList.remove('hidden');
                        app.timer.runningControls.classList.add('hidden');
                    }
                }, 1000);
            };

            const stopTimer = (hideOverlay = false) => {
                clearInterval(timerInterval);
                timerInterval = null;
                if (hideOverlay) {
                    app.timer.overlay.classList.add('hidden');
                    app.timer.overlay.classList.remove('flex');
                    currentTimerTask = null;
                    pendingActionTaskId = null;
                }
            };
            
            // --- Novas Fun√ß√µes de Fluxo ---
            function openSchedulePrompt(taskId) {
                pendingActionTaskId = taskId;
                const task = findTask(taskId);
                app.scheduleModal.taskText.textContent = task.text;
                app.scheduleModal.dateInput.value = '';
                app.scheduleModal.timeInput.value = '';
                app.scheduleModal.endTimeInput.value = '';
                app.scheduleModal.saveBtn.disabled = true;
                app.scheduleModal.element.classList.remove('hidden');
            }

            // --- L√≥gica do Tutorial ---
            let tutorialStep = 0;
            const tutorialSteps = [
                {
                    content: `
                        <h3 class="text-xl font-bold text-white mb-4">Bem-vindo ao EVOMYND!</h3>
                        <p class="text-gray-600">Este √© um guia r√°pido para come√ßar. Usaremos a tarefa de exemplo <strong class="text-gray-900">"Marcar dentista"</strong> para mostrar como tudo funciona. Vamos process√°-la.</p>
                    `,
                    action: 'next',
                },
                {
                    content: `<p class="text-gray-600">Clique no bot√£o <strong class="text-gray-900">Processar</strong> para decidir o que fazer com este item.</p>`,
                    target: () => document.querySelector('.process-btn'),
                    action: 'click_target',
                },
                {
                    content: `
                        <h3 class="text-xl font-bold text-white mb-4">O que √© um "Contexto"?</h3>
                        <p class="text-gray-600">Contexto √© a ferramenta, lugar ou pessoa que voc√™ precisa para realizar a tarefa. Ajuda a filtrar suas a√ß√µes.</p>
                        <p class="text-gray-700 mt-2">Para "Marcar dentista", o contexto seria <strong class="text-gray-900">@telefone</strong>. Tente adicionar um contexto, iniciando com @, e salvar.</p>
                    `,
                    target: () => document.getElementById('context-wrapper'),
                    action: 'submit_form',
                },
                {
                    content: `
                        <h3 class="text-xl font-bold text-white mb-4">Fazer agora?</h3>
                        <p class="text-gray-600">Esta √© uma a√ß√£o para fazer em menos de 2 minutos? Se sim, voc√™ pode faz√™-la agora com um timer de 2 minutos. Para continuar o guia, clique em <strong class="text-gray-900">"N√£o"</strong>.</p>
                    `,
                    target: () => app.quickActionModal.noBtn,
                    action: 'click_target_special'
                },
                {
                    content: `
                        <h3 class="text-xl font-bold text-white mb-4">Agendar?</h3>
                        <p class="text-gray-600">Voc√™ pode programar esta a√ß√£o para uma data e hora espec√≠ficas, e ela aparecer√° no Calend√°rio aqui do EVOMYND. Por agora, vamos apenas adicion√°-la √† lista de Pr√≥ximas A√ß√µes. Clique em <strong class="text-gray-900">"Agora n√£o"</strong>.</p>
                    `,
                    target: () => app.scheduleModal.laterBtn,
                    action: 'click_target_special'
                },
                {
                    content: `
                        <h3 class="text-xl font-bold text-white mb-4">Pronto!</h3>
                        <p class="text-gray-600">Voc√™ processou seu primeiro item! Agora voc√™ pode encontrar "Marcar dentista" na sua lista de "Pr√≥ximas A√ß√µes".</p>
                    `,
                    action: 'next',
                }
            ];

            function advanceTutorial() {
                tutorialStep++;
                executeTutorialStep();
            }

            function endTutorial() {
                app.tutorial.modal.classList.add('hidden');
                document.querySelectorAll('.tutorial-highlight').forEach(el => el.classList.remove('tutorial-highlight'));
                localStorage.setItem('gtd_tutorial_completed', 'true');
            }

            function executeTutorialStep() {
                document.querySelectorAll('.tutorial-highlight').forEach(el => el.classList.remove('tutorial-highlight'));
                
                if (tutorialStep >= tutorialSteps.length) {
                    endTutorial();
                    return;
                }

                const step = tutorialSteps[tutorialStep];
                app.tutorial.content.innerHTML = step.content;
                app.tutorial.modal.classList.remove('hidden');

                const targetElement = step.target ? step.target() : null;

                if (step.action === 'next') {
                    app.tutorial.nextBtn.textContent = (tutorialStep === tutorialSteps.length - 1) ? 'Concluir' : 'Pr√≥ximo';
                    app.tutorial.nextBtn.onclick = advanceTutorial;
                } else {
                    app.tutorial.nextBtn.textContent = 'Entendi';
                    app.tutorial.nextBtn.onclick = () => {
                        app.tutorial.modal.classList.add('hidden');
                        if (targetElement) {
                            targetElement.classList.add('tutorial-highlight');
                            const eventType = step.action === 'submit_form' ? 'submit' : 'click';
                            const listenerTarget = step.action === 'submit_form' ? app.modal.form : targetElement;
                            
                            listenerTarget.addEventListener(eventType, function handler(e) {
                                setTimeout(() => {
                                    document.querySelectorAll('.tutorial-highlight').forEach(el => el.classList.remove('tutorial-highlight'));
                                    advanceTutorial();
                                }, 150);
                            }, { once: true });
                        }
                    };
                }
            }

            app.tutorial.skipBtn.addEventListener('click', endTutorial);

            function startTutorial() {
                if (localStorage.getItem('gtd_tutorial_completed') !== 'true' && tasks.some(t => t.text === 'Marcar dentista')) {
                    tutorialStep = 0;
                    executeTutorialStep();
                }
            }

            function restartTutorial() {
                // Remove a flag de tutorial completado
                localStorage.removeItem('gtd_tutorial_completed');
                
                // Adiciona a tarefa de exemplo se n√£o existir
                if (!tasks.some(t => t.text === 'Marcar dentista')) {
                    tasks.unshift({ id: Date.now().toString(), text: 'Marcar dentista', status: 'inbox', context: null });
                    saveTasks();
                }
                
                // Vai para a inbox e reinicia o tutorial
                currentView = 'inbox-view';
                render();
                tutorialStep = 0;
                executeTutorialStep();
            }


            // --- EVENT LISTENERS ---
            app.addTaskBtn.addEventListener('click', addTask);
            app.newTaskInput.addEventListener('keypress', (e) => e.key === 'Enter' && addTask());
            
            app.newTaskInput.addEventListener('focus', () => {
                setTimeout(() => {
                    app.newTaskInput.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center',
                    });
                }, 300);
            });
            
            app.navTabs.forEach(tab => tab.addEventListener('click', () => { 
                currentView = tab.dataset.view; 
                render(); 
            }));
            
            // Listeners do Timer
            app.timer.earlyCompleteBtn.addEventListener('click', () => {
                stopTimer(true);
            });

            app.timer.cancelBtn.addEventListener('click', () => {
                tasks.unshift(currentTimerTask);
                stopTimer(true);
                render();
            });
            
            app.timer.completeBtn.addEventListener('click', () => {
                stopTimer(true);
            });

            app.timer.restartBtn.addEventListener('click', startTimer);
            
            app.timer.moveBtn.addEventListener('click', () => {
                tasks.unshift(currentTimerTask);
                stopTimer(true);
                render();
            });

            app.timer.pauseBtn.addEventListener('click', () => {
                isTimerPaused = !isTimerPaused;
                if (isTimerPaused) {
                    clearInterval(timerInterval);
                    app.timer.pauseBtn.textContent = 'Voltar';
                } else {
                    timerInterval = setInterval(() => {
                        timerSeconds--;
                        const minutes = Math.floor(timerSeconds / 60).toString().padStart(2, '0');
                        const seconds = (timerSeconds % 60).toString().padStart(2, '0');
                        app.timer.display.textContent = `${minutes}:${seconds}`;
                        if (timerSeconds <= 0) {
                            stopTimer();
                            app.timer.finishedControls.classList.remove('hidden');
                            app.timer.runningControls.classList.add('hidden');
                        }
                    }, 1000);
                    app.timer.pauseBtn.textContent = 'Pausar';
                }
            });

            // Listeners dos novos modais
            app.quickActionModal.yesBtn.addEventListener('click', () => {
                app.quickActionModal.element.classList.add('hidden');
                startTimer();
            });
            app.quickActionModal.noBtn.addEventListener('click', () => {
                app.quickActionModal.element.classList.add('hidden');
                openSchedulePrompt(pendingActionTaskId);
            });
            app.scheduleModal.laterBtn.addEventListener('click', () => {
                app.scheduleModal.element.classList.add('hidden');
                pendingActionTaskId = null;
            });
            app.scheduleModal.dateInput.addEventListener('input', () => {
                app.scheduleModal.saveBtn.disabled = !app.scheduleModal.dateInput.value;
            });
            app.scheduleModal.saveBtn.addEventListener('click', () => {
                const task = findTask(pendingActionTaskId);
                if (task) {
                    task.dueDate = app.scheduleModal.dateInput.value;
                    task.dueTime = app.scheduleModal.timeInput.value;
                    task.endTime = app.scheduleModal.endTimeInput.value;
                    
                    // Salvar tarefa e renderizar
                    saveTasks();
                    render();
                    
                    // Preparar dados para exporta√ß√£o
                    pendingCalendarExport = {
                        text: task.text,
                        dueDate: task.dueDate,
                        dueTime: task.dueTime,
                        endTime: task.endTime
                    };
                    
                    // Mostrar modal de pergunta
                    app.scheduleModal.element.classList.add('hidden');
                    app.calendarExportModal.element.classList.remove('hidden');
                }
                pendingActionTaskId = null;
            });

            // Listeners do modal de exporta√ß√£o para calend√°rio
            app.calendarExportModal.yesBtn.addEventListener('click', () => {
                if (pendingCalendarExport) {
                    // Criar URL do Google Calendar
                    const startDateTime = pendingCalendarExport.dueTime 
                        ? `${pendingCalendarExport.dueDate.replace(/-/g, '')}T${pendingCalendarExport.dueTime.replace(':', '')}00`
                        : `${pendingCalendarExport.dueDate.replace(/-/g, '')}`;
                    
                    let endDateTime;
                    if (pendingCalendarExport.endTime) {
                        endDateTime = `${pendingCalendarExport.dueDate.replace(/-/g, '')}T${pendingCalendarExport.endTime.replace(':', '')}00`;
                    } else if (pendingCalendarExport.dueTime) {
                        const [hours, minutes] = pendingCalendarExport.dueTime.split(':');
                        const endHour = (parseInt(hours) + 1).toString().padStart(2, '0');
                        endDateTime = `${pendingCalendarExport.dueDate.replace(/-/g, '')}T${endHour}${minutes}00`;
                    } else {
                        endDateTime = `${pendingCalendarExport.dueDate.replace(/-/g, '')}`;
                    }
                    
                    const googleCalendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(pendingCalendarExport.text)}&dates=${startDateTime}/${endDateTime}&details=${encodeURIComponent('Criado no EVOMYND')}`;
                    
                    // Abrir calend√°rio
                    window.open(googleCalendarUrl, '_blank');
                    
                    pendingCalendarExport = null;
                }
                app.calendarExportModal.element.classList.add('hidden');
            });

            app.calendarExportModal.noBtn.addEventListener('click', () => {
                pendingCalendarExport = null;
                app.calendarExportModal.element.classList.add('hidden');
            });

            
            
            document.body.addEventListener('click', (e) => {
                const button = e.target.closest('button, a');
                if (!button) return;

                const id = button.dataset.id;
                
                // Bot√£o "Processar" - abre direto modal de Pr√≥ximas A√ß√µes
                if (button.classList.contains('process-btn')) {
                    e.preventDefault();
                    openTaskModal(findTask(id), 'process');
                    return;
                }
                
                // Bot√£o "Fazer agora" - inicia timer de 2 minutos
                if (button.classList.contains('do-now-btn')) {
                    e.preventDefault();
                    const task = findTask(id);
                    if (task) {
                        console.log('Iniciando timer para tarefa:', task.text);
                        currentTimerTask = task;
                        pendingActionTaskId = null; // Limpar para evitar conflito
                        startTimer();
                    } else {
                        console.error('Tarefa n√£o encontrada:', id);
                    }
                    return;
                }

                if (button.classList.contains('edit-btn')) openTaskModal(findTask(id), 'edit');
                if (button.classList.contains('delete-btn')) deleteTask(id);
                if (button.classList.contains('done-btn')) deleteTask(id);
                if (button.classList.contains('toggle-subtasks-btn')) {
                    const container = document.getElementById(`subtasks-container-${id}`);
                    if (container) {
                        const isHidden = container.classList.contains('hidden');
                        if (isHidden) renderSubTasks(id);
                        container.classList.toggle('hidden');
                    }
                }
                if (button.classList.contains('add-subtask-btn')) {
                    const projectId = button.dataset.projectId;
                    const project = findTask(projectId);
                    const textInput = document.querySelector(`.new-subtask-input[data-project-id="${projectId}"]`);
                    const dateInput = document.querySelector(`.subtask-due-date[data-project-id="${projectId}"]`);
                    const startTimeInput = document.querySelector(`.subtask-start-time[data-project-id="${projectId}"]`);
                    const endTimeInput = document.querySelector(`.subtask-end-time[data-project-id="${projectId}"]`);
                    
                    const text = textInput.value.trim();
                    const dueDate = dateInput.value;
                    const dueTime = startTimeInput.value;
                    const endTime = endTimeInput.value;
                    
                    // Valida√ß√µes
                    if (!text) {
                        alert('Por favor, descreva a a√ß√£o.');
                        return;
                    }
                    if (!dueDate) {
                        alert('Por favor, informe a data.');
                        return;
                    }
                    if (!dueTime) {
                        alert('Por favor, informe a hora de in√≠cio.');
                        return;
                    }
                    if (!endTime) {
                        alert('Por favor, informe a hora de t√©rmino.');
                        return;
                    }
                    
                    // Validar que hora fim > hora in√≠cio
                    if (endTime <= dueTime) {
                        alert('A hora de t√©rmino deve ser posterior √† hora de in√≠cio.');
                        return;
                    }
                    
                    // Validar data/hora n√£o est√° no passado
                    const taskDateTime = new Date(`${dueDate}T${endTime}`);
                    const now = new Date();
                    if (taskDateTime < now) {
                        alert('N√£o √© poss√≠vel definir uma data/hora no passado.');
                        return;
                    }
                    
                    // Validar que a data da a√ß√£o n√£o √© posterior √† data de conclus√£o do projeto
                    if (project && project.dueDate) {
                        const projectDueDate = new Date(project.dueDate + 'T23:59:59');
                        const actionEndDateTime = new Date(`${dueDate}T${endTime}`);
                        
                        if (actionEndDateTime > projectDueDate) {
                            alert(`A a√ß√£o n√£o pode ter data/hora posterior √† data de conclus√£o do projeto (${new Date(project.dueDate + 'T00:00:00').toLocaleDateString('pt-BR')}).`);
                            return;
                        }
                    }
                    
                    if (project) {
                        if(!project.subTasks) project.subTasks = [];
                        const newSubtask = { 
                            id: Date.now().toString(), 
                            text, 
                            completed: false, 
                            dueDate, 
                            dueTime,
                            endTime 
                        };
                        project.subTasks.push(newSubtask);
                        
                        // Limpar campos
                        textInput.value = '';
                        dateInput.value = '';
                        startTimeInput.value = '';
                        endTimeInput.value = '';
                        
                        saveTasks();
                        renderSubTasks(projectId);
                        
                        // Perguntar se quer adicionar ao calend√°rio
                        showCalendarPrompt({
                            text,
                            dueDate,
                            dueTime,
                            endTime,
                            project: project.text
                        });
                    }
                }
                if (button.classList.contains('delete-subtask-btn')) {
                    const projectId = button.dataset.projectId;
                    const subtaskId = button.dataset.subtaskId;
                    const project = findTask(projectId);
                    if (project) {
                        project.subTasks = project.subTasks.filter(st => st.id !== subtaskId);
                        saveTasks();
                        renderSubTasks(projectId);
                    }
                }
            });

            document.body.addEventListener('change', (e) => {
                const target = e.target;
                if (target.classList.contains('subtask-checkbox')) {
                    const { projectId, subtaskId } = target.dataset;
                    const project = findTask(projectId);
                    if (project) {
                        const subtask = project.subTasks.find(st => st.id === subtaskId);
                        if (subtask) {
                            subtask.completed = target.checked;
                            saveTasks();
                            renderSubTasks(projectId);
                        }
                    }
                }
            });

            document.body.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && e.target.classList.contains('new-subtask-input')) {
                    e.preventDefault();
                    const projectId = e.target.dataset.projectId;
                    document.querySelector(`.add-subtask-btn[data-project-id="${projectId}"]`)?.click();
                }
            });
            
            app.modal.form.addEventListener('submit', saveTask);
            app.modal.cancelBtn.addEventListener('click', closeModal);
            app.modal.destinationRadios.forEach(radio => radio.addEventListener('change', (e) => {
                const taskId = app.modal.taskId.value;
                const currentTask = findTask(taskId);
                const currentText = document.getElementById('task-text-input')?.value || currentTask.text;
                const tempTask = { ...currentTask, text: currentText };
                const mode = app.modal.mode.value;
                updateModalForm(e.target.value, tempTask, mode);
                
                // Atualizar estilos dos bot√µes do modal
                app.modal.destinationRadios.forEach(r => {
                    const label = r.parentElement;
                    if (r.checked) {
                        label.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-white');
                        label.classList.add('bg-blue-600', 'text-white');
                    } else {
                        label.classList.remove('bg-blue-600', 'text-white');
                        label.classList.add('bg-gray-100', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-white');
                    }
                });
            }));

            // --- REVIS√ÉO SEMANAL ---
            function startWeeklyReview() {
                isWeeklyReviewActive = true;
                weeklyReviewStep = 0;
                document.getElementById('footer-spacer').classList.remove('hidden');
                app.weeklyReview.footer.classList.remove('hidden');
                updateWeeklyReviewStep();
            }

            function updateWeeklyReviewStep() {
                const step = WEEKLY_REVIEW_STEPS[weeklyReviewStep];
                if (!step) return;

                // Atualiza a view
                currentView = step.view;
                render();

                // Atualiza o footer
                app.weeklyReview.stepLabel.textContent = step.title;
                const progress = ((weeklyReviewStep + 1) / WEEKLY_REVIEW_STEPS.length) * 100;
                app.weeklyReview.progress.style.width = `${progress}%`;

                // Atualiza o bot√£o
                if (weeklyReviewStep === WEEKLY_REVIEW_STEPS.length - 1) {
                    app.weeklyReview.nextBtn.textContent = 'Concluir';
                } else {
                    app.weeklyReview.nextBtn.textContent = 'Pr√≥ximo';
                }

                // Rola a p√°gina para mostrar os itens
                setTimeout(() => {
                    const viewElement = document.getElementById(step.view);
                    if (viewElement) {
                        const headerHeight = 100; // altura aproximada do cabe√ßalho
                        const targetScroll = viewElement.offsetTop - headerHeight;
                        window.scrollTo({
                            top: targetScroll,
                            behavior: 'smooth'
                        });

                        // Garante que o footer-spacer est√° vis√≠vel e rolado para o fim da lista
                        const spacer = document.getElementById('footer-spacer');
                        if (spacer) {
                            spacer.classList.remove('hidden');
                            
                            // Adiciona classe para margens extras nas listas quando a revis√£o est√° ativa
                            document.querySelectorAll('[id$="-list"]').forEach(list => {
                                list.classList.add('review-active');
                            });
                        }
                    }
                }, 100);
            }

            function nextWeeklyReviewStep() {
                if (weeklyReviewStep < WEEKLY_REVIEW_STEPS.length - 1) {
                    weeklyReviewStep++;
                    updateWeeklyReviewStep();
                } else {
                    completeWeeklyReview();
                }
            }

            function updateNextReviewDate() {
                const today = new Date();
                const nextWeek = new Date(today);
                nextWeek.setDate(today.getDate() + 7);
                nextReviewDate = nextWeek.toISOString().split('T')[0];
                localStorage.setItem('next_review_date', nextReviewDate);
                
                const nextReviewDateEl = document.getElementById('next-review-date');
                if (nextReviewDateEl) {
                    const formattedDate = new Date(nextReviewDate).toLocaleDateString('pt-BR', {
                        day: '2-digit',
                        month: '2-digit'
                    });
                    nextReviewDateEl.textContent = `Pr√≥xima: ${formattedDate}`;
                }
            }

            function completeWeeklyReview() {
                isWeeklyReviewActive = false;
                app.weeklyReview.footer.classList.add('hidden');
                document.getElementById('footer-spacer').classList.add('hidden');
                app.weeklyReview.completeModal.classList.remove('hidden');
                updateNextReviewDate();
            }

            function closeWeeklyReviewComplete() {
                app.weeklyReview.completeModal.classList.add('hidden');
                currentView = 'inbox-view';
                render();
            }

            // Fun√ß√£o para mostrar a data da pr√≥xima revis√£o ao carregar
            function showNextReviewDate() {
                const nextReviewDateEl = document.getElementById('next-review-date');
                if (nextReviewDateEl && nextReviewDate) {
                    const formattedDate = new Date(nextReviewDate).toLocaleDateString('pt-BR', {
                        day: '2-digit',
                        month: '2-digit'
                    });
                    nextReviewDateEl.textContent = `Pr√≥xima: ${formattedDate}`;
                }
            }

            // Event Listeners da Revis√£o Semanal
            app.weeklyReview.button.addEventListener('click', startWeeklyReview);
            app.weeklyReview.nextBtn.addEventListener('click', nextWeeklyReviewStep);
            app.weeklyReview.completeCloseBtn.addEventListener('click', closeWeeklyReviewComplete);

            // Fun√ß√£o para atualizar informa√ß√µes de assinatura no modal
            async function updateSubscriptionInfo() {
                const container = document.getElementById('subscription-info-container');
                const renewBtn = document.getElementById('renew-subscription-settings-btn');
                
                if (!currentUser) {
                    container.classList.add('hidden');
                    return;
                }
                
                try {
                    const subscription = await checkSubscription(currentUser.uid);
                    
                    // Mostrar container
                    container.classList.remove('hidden');
                    
                    // Status
                    const statusElement = document.getElementById('sub-status');
                    const statusText = {
                        'trial': 'üéÅ Teste Gr√°tis',
                        'active': '‚úÖ Ativa',
                        'expired': '‚ùå Expirada',
                        'error': '‚ö†Ô∏è Erro'
                    };
                    statusElement.textContent = statusText[subscription.status] || subscription.status;
                    statusElement.className = subscription.active ? 'font-semibold text-green-600 dark:text-green-400' : 'font-semibold text-red-600 dark:text-red-400';
                    
                    // Plano
                    const planElement = document.getElementById('sub-plan');
                    const planText = {
                        'trial': 'Teste Gratuito',
                        'premium_monthly': 'Premium Mensal',
                        'premium_annual': 'Premium Anual',
                        'premium': 'Premium'
                    };
                    planElement.textContent = planText[subscription.status] || 'Gratuito';
                    
                    // Data de expira√ß√£o
                    const expiresElement = document.getElementById('sub-expires');
                    if (subscription.expiresAt) {
                        const date = new Date(subscription.expiresAt);
                        expiresElement.textContent = date.toLocaleDateString('pt-BR', { 
                            day: '2-digit', 
                            month: '2-digit', 
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    } else {
                        expiresElement.textContent = 'N/A';
                    }
                    
                    // Dias restantes
                    const daysElement = document.getElementById('sub-days');
                    if (subscription.daysRemaining !== undefined) {
                        daysElement.textContent = `${subscription.daysRemaining} dia(s)`;
                        daysElement.className = subscription.daysRemaining <= 3 ? 'font-semibold text-red-600 dark:text-red-400' : 'font-semibold text-green-600 dark:text-green-400';
                    } else {
                        daysElement.textContent = 'N/A';
                    }
                    
                    // User ID
                    document.getElementById('sub-userid').textContent = currentUser.uid;
                    
                    // Mostrar bot√£o de renovar apenas se for trial ou estiver perto de expirar
                    if (subscription.status === 'trial' || (subscription.active && subscription.daysRemaining <= 7)) {
                        renewBtn.classList.remove('hidden');
                    } else {
                        renewBtn.classList.add('hidden');
                    }
                    
                } catch (error) {
                    console.error('Erro ao carregar informa√ß√µes de assinatura:', error);
                    container.classList.add('hidden');
                }
            }

            // Event Listeners do Modal de Configura√ß√µes
            app.settings.openBtn.addEventListener('click', async () => {
                app.settings.modal.classList.remove('hidden');
                // Atualizar informa√ß√µes de assinatura ao abrir o modal
                await updateSubscriptionInfo();
            });

            app.settings.closeBtn.addEventListener('click', () => {
                app.settings.modal.classList.add('hidden');
            });

            app.settings.doneBtn.addEventListener('click', () => {
                app.settings.modal.classList.add('hidden');
            });

            app.settings.themeToggle.addEventListener('click', toggleTheme);

            app.settings.restartTutorialBtn.addEventListener('click', () => {
                app.settings.modal.classList.add('hidden');
                restartTutorial();
            });

            // Bot√£o de renovar assinatura no modal de configura√ß√µes
            document.getElementById('renew-subscription-settings-btn')?.addEventListener('click', () => {
                const userId = currentUser?.uid || '';
                const checkoutUrl = `https://mpago.la/2174QUB?external_reference=${userId}`;
                window.open(checkoutUrl, '_blank');
            });

            // --- INICIALIZA√á√ÉO ---
            applyTheme(currentTheme); // Aplica o tema salvo
            render();
            startTutorial();
            showNextReviewDate();
        });
    </script>
</body>
</html>
